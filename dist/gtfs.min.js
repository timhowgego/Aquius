var gtfsToAquius=gtfsToAquius||{init:function(configId){function createElement(elementType,valueObject,styleObject){var values,styles,i,element=document.createElement(elementType);if(void 0!==valueObject)for(values=Object.keys(valueObject),i=0;i<values.length;i+=1)element[values[i]]=valueObject[values[i]];if(void 0!==styleObject)for(styles=Object.keys(styleObject),i=0;i<styles.length;i+=1)element.style[styles[i]]=styleObject[styles[i]];return element}function createTabulation(tableData,tableHeader,tableDataStyle,caption){var td,th,tr,i,j,table=createElement("table");if(void 0!==caption&&table.appendChild(createElement("caption",{textContent:caption})),tableHeader.length>0){for(tr=createElement("tr"),i=0;i<tableHeader.length;i+=1)"object"==typeof tableHeader[i]?((th=createElement("th")).appendChild(tableHeader[i]),tr.appendChild(th)):tr.appendChild(createElement("th",{textContent:tableHeader[i].toString()}));table.appendChild(tr)}for(i=0;i<tableData.length;i+=1){for(tr=createElement("tr"),j=0;j<tableData[i].length;j+=1)"object"==typeof tableData[i][j]?(td=createElement("td")).appendChild(tableData[i][j]):td=createElement("td",{textContent:tableData[i][j].toString()}),void 0!==tableDataStyle&&tableDataStyle.length>j&&(td.className=tableDataStyle[j]),tr.appendChild(td);table.appendChild(tr)}return table}function outputProcess(error,out,options){var caption,content,keys,i,vars=options._vars,fileDOM=document.getElementById(vars.configId+"ImportFiles"),outputDOM=document.getElementById(vars.configId+"Output"),progressDOM=document.getElementById(vars.configId+"Progress");if(void 0!==error)return outputError(error,vars),!1;if(!outputDOM||!progressDOM)return!1;for(;outputDOM.firstChild;)outputDOM.removeChild(outputDOM.firstChild);for(;progressDOM.firstChild;)progressDOM.removeChild(progressDOM.firstChild);for(null!==fileDOM&&(fileDOM.disabled=!1),outputDOM.className="",keys=["aquius","config"],i=0;i<keys.length;i+=1)keys[i]in out&&Object.keys(out[keys[i]]).length>0&&(content="config"===keys[i]?JSON.stringify(out[keys[i]],null,1):JSON.stringify(out[keys[i]]),progressDOM.appendChild(createElement("a",{className:vars.configId+"Download",href:window.URL.createObjectURL(new Blob([content],{type:"application/json;charset=utf-8"})),download:keys[i]+".json",textContent:"Save "+keys[i]+".json",role:"button"})));if(caption="aquius"in out&&"translation"in out.aquius&&"en-US"in out.aquius.translation&&"link"in out.aquius.translation["en-US"]?out.aquius.translation["en-US"].link:"Services","undefined"!=typeof aquius&&"aquius"in out&&(outputDOM.appendChild(createElement("div",{id:vars.configId+"Map"},{height:document.documentElement.clientHeight/2+"px"})),aquius.init(vars.configId+"Map",{dataObject:out.aquius,uiStore:!1})),"warning"in out)for(i=0;i<out.warning.length;i+=1)outputDOM.appendChild(createElement("p",{textContent:out.warning[i]}));"networkTable"in out&&outputDOM.appendChild(createTabulation(out.networkTable.data,out.networkTable.header,out.networkTable.format,caption+" by Network")),"summaryTable"in out&&outputDOM.appendChild(createTabulation(out.summaryTable.data,out.summaryTable.header,out.summaryTable.format,caption+" % by Hour (scheduled only)"))}function outputError(error,vars){var message,fileDOM=document.getElementById(vars.configId+"ImportFiles"),outputDOM=document.getElementById(vars.configId+"Output"),progressDOM=document.getElementById(vars.configId+"Progress");if(void 0!==error&&null!==outputDOM){for(;outputDOM.firstChild;)outputDOM.removeChild(outputDOM.firstChild);if(outputDOM.className=vars.configId+"OutputError",message="message"in error?error.message:JSON.stringify(error),outputDOM.appendChild(createElement("p",{textContent:"Error: "+message})),null!==progressDOM){for(;progressDOM.firstChild;)progressDOM.removeChild(progressDOM.firstChild);progressDOM.textContent="Failed"}null!==fileDOM&&(fileDOM.disabled=!1)}}return function(vars,loadFunction,prompt){var button,form,label,baseDOM=document.getElementById(vars.configId);if(!baseDOM)return!1;for(;baseDOM.firstChild;)baseDOM.removeChild(baseDOM.firstChild);return Object.keys&&[].indexOf&&"object"==typeof JSON&&window.File&&window.FileReader&&window.Blob?(document.head.appendChild(createElement("script",{src:"https://timhowgego.github.io/Aquius/dist/aquius.min.js",type:"text/javascript"})),form=createElement("form",{className:vars.configId+"Input"}),label=createElement("label",{textContent:prompt}),(button=createElement("input",{id:vars.configId+"ImportFiles",multiple:"multiple",name:vars.configId+"ImportFiles[]",type:"file"})).addEventListener("change",(function(){loadFunction(vars)}),!1),label.appendChild(button),form.appendChild(label),form.appendChild(createElement("span",{id:vars.configId+"Progress"})),baseDOM.appendChild(form),baseDOM.appendChild(createElement("div",{id:vars.configId+"Output"})),!0):(baseDOM.appendChild(document.createTextNode("Browser not supported: Try a modern browser")),!1)}({configId:configId,process:this.process},(function(vars){var reader,gtfs={},nonText={},fileDOM=document.getElementById(vars.configId+"ImportFiles"),options={_vars:vars,callback:outputProcess},processedFiles=0,progressDOM=document.getElementById(vars.configId+"Progress"),totalFiles=0;function onLoad(filename,position,result){var filenameParts,json,key,keys,i;if((filenameParts=filename.toLowerCase().split(".")).length>1&&"txt"===filenameParts[filenameParts.length-1]?((key=filenameParts.slice(0,filenameParts.length-1).join("."))in gtfs==!1&&(gtfs[key]=[]),gtfs[key][position]=result):((key=filenameParts.join("."))in nonText==!1&&(nonText[key]=[]),nonText[key][position]=result),(processedFiles+=1)===totalFiles){for(keys=Object.keys(nonText),i=0;i<keys.length;i+=1)try{"type"in(json=JSON.parse(nonText[keys[i]].join("")))&&"FeatureCollection"===json.type?options.geojson=json:options.config=json}catch(err){err instanceof SyntaxError==!1&&outputError(err,vars)}vars.process(gtfs,options)}}if(null!==fileDOM&&fileDOM.files.length>0){if(fileDOM.disabled=!0,null!==progressDOM){for(;progressDOM.firstChild;)progressDOM.removeChild(progressDOM.firstChild);progressDOM.textContent="Working..."}!function(files){var theChunk,chunkedSize,i,fileList=[];for(i=0;i<files.length;i+=1)for(chunkedSize=0;files[i].size>=chunkedSize;)fileList.push([files[i],parseInt(chunkedSize/1e8,10)]),chunkedSize+=1e8;for(totalFiles=fileList.length,i=0;i<totalFiles;i+=1)(reader=new FileReader).onerror=function(evt,theFile){outputError(new Error("Could not read "+theFile[0].name),vars),reader.abort()},reader.onload=function(theFile){return function(){try{onLoad(theFile[0].name,theFile[1],this.result)}catch(err){outputError(err,vars)}}}(fileList[i]),theChunk=fileList[i][0].slice(1e8*fileList[i][1],1e8*fileList[i][1]+1e8),reader.readAsText(theChunk)}(fileDOM.files)}}),"GTFS as .txt, optional config, and optional GeoJSON to process:")},process:function(gtfs,options){var out={_:{},aquius:{},config:{},summary:{}};function formatGtfsDate(dateMS){var dateDate=new Date(dateMS),dateString=dateDate.getFullYear().toString();return dateDate.getMonth()<9&&(dateString+="0"),dateString+=(dateDate.getMonth()+1).toString(),dateDate.getDate()<10&&(dateString+="0"),dateString+=dateDate.getDate().toString()}function unformatGtfsDate(dateString){return dateString.length<8?0:Date.UTC(dateString.slice(0,4),dateString.slice(4,6)-1,dateString.slice(6,8))}function haversineDistance(lat1,lng1,lat2,lng2){var rad=Math.PI/180,sinDLat=Math.sin((lat2-lat1)*rad/2),sinDLon=Math.sin((lng2-lng1)*rad/2),a=sinDLat*sinDLat+Math.cos(lat1*rad)*Math.cos(lat2*rad)*sinDLon*sinDLon;return 6371e3*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))}function parseCsv(out,slug,csv){var firstLine,lastIndex,match,matches,residual,i,j,columns=-1,pattern=new RegExp('(\\,|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^\\,\\r\\n]*))',"gi"),indexColumn=-1,line=[];function processLine(out,line,slug,columns,indexColumn){return line.length===columns&&(-1!==indexColumn?(line[indexColumn]in out.gtfs[slug]==!1&&(out.gtfs[slug][line[indexColumn]]=[]),out.gtfs[slug][line[indexColumn]].push(line)):out.gtfs[slug].push(line)),out}for(Array.isArray(csv)||(csv=[csv]),i=0;i<csv.length;i+=1)for(matches=pattern.exec(csv[i]),lastIndex=line.length-1,firstLine=!0;null!==matches;){if(matches[1].length&&","!==matches[1]){if(i>0&&!0===firstLine&&(line.length>columns&&lastIndex<line.length-1&&((residual=line.slice(0,lastIndex)).push(line[lastIndex]+line[lastIndex+1]),line=residual.concat(line.slice(lastIndex+2))),firstLine=!1),-1===columns){for(columns=line.length,j=0;j<line.length;j+=1)line[j]in out.gtfsHead[slug]&&(out.gtfsHead[slug][line[j]]=j);if(slug in out.gtfsRequired)for(j=0;j<out.gtfsRequired[slug].length;j+=1)if(-1===out.gtfsHead[slug][out.gtfsRequired[slug][j]])return"error"in out==!1&&(out.error=[]),out.error.push("Missing value "+out.gtfsRequired[slug][j]+" in GTFS "+slug+".txt"),out;if(slug in out.gtfsIndex){if(-1===(indexColumn=out.gtfsHead[slug][out.gtfsIndex[slug]]))return"error"in out==!1&&(out.error=[]),out.error.push("Missing index value "+out.gtfsIndex[slug]+" in GTFS "+slug+".txt"),out;out.gtfs[slug]={}}else out.gtfs[slug]=[]}else out=processLine(out,line,slug,columns,indexColumn);line=[]}void 0===(match=matches[2]?matches[2].replace(new RegExp('""',"g"),'"'):matches[3])&&(match=""),line.push(match.trim()),matches=pattern.exec(csv[i])}return out=processLine(out,line,slug,columns,indexColumn)}function addToReference(out,key,value){return"reference"in out.aquius==!1&&(out.aquius.reference={}),key in out.aquius.reference==!1&&(out.aquius.reference[key]=[],out._[key]={}),value in out._[key]==!1&&(out.aquius.reference[key].push(value),out._[key][value]=out.aquius.reference[key].length-1),out}function createNodeProperties(out,stopObject,index){var codeString,contentString,position,properties={};function withinKeys(properties,reference){var match,i,j,keys=Object.keys(properties);for(i=0;i<reference.length;i+=1){for(match=!0,j=0;j<keys.length;j+=1)if(keys[j]in reference[i]==!1||reference[i][keys[j]]!==properties[keys[j]]){match=!1;break}if(!0===match)return!0}return!1}return!0===out.config.allowName&&(contentString="",stopObject[out.gtfsHead.stops.stop_id]in out.config.stopOverride&&"stop_name"in out.config.stopOverride[stopObject[out.gtfsHead.stops.stop_id]]?contentString=out.config.stopOverride[stopObject[out.gtfsHead.stops.stop_id]].stop_name:-1!==out.gtfsHead.stops.stop_name&&(contentString=stopObject[out.gtfsHead.stops.stop_name].trim()),""!==contentString&&(properties.n=contentString)),!0===out.config.allowStopUrl&&(contentString="",stopObject[out.gtfsHead.stops.stop_id]in out.config.stopOverride&&"stop_url"in out.config.stopOverride[stopObject[out.gtfsHead.stops.stop_id]]?contentString=out.config.stopOverride[stopObject[out.gtfsHead.stops.stop_id]].stop_url:-1!==out.gtfsHead.stops.stop_url&&(contentString=stopObject[out.gtfsHead.stops.stop_url].trim()),""!==contentString&&("[*]",-1===(position=contentString.lastIndexOf("[*]"))&&-1!==out.gtfsHead.stops.stop_code&&(codeString=stopObject[out.gtfsHead.stops.stop_code].trim(),-1!==(position=contentString.lastIndexOf(codeString))&&(contentString=contentString.substring(0,position)+"[*]"+contentString.substring(position+codeString.length),properties.i=codeString)),-1===position&&-1!==out.gtfsHead.stops.stop_id&&(codeString=stopObject[out.gtfsHead.stops.stop_id].trim(),-1!==(position=contentString.lastIndexOf(codeString))&&(contentString=contentString.substring(0,position)+"[*]"+contentString.substring(position+codeString.length),properties.i=codeString)),out=addToReference(out,"url",contentString),properties.u=out._.url[contentString])),Object.keys(properties).length>0&&("r"in out.aquius.node[index][2]?!1===withinKeys(properties,out.aquius.node[index][2].r)&&out.aquius.node[index][2].r.push(properties):out.aquius.node[index][2].r=[properties]),!0===out.config.allowCode&&(properties={},stopObject[out.gtfsHead.stops.stop_id]in out.config.stopOverride&&"stop_code"in out.config.stopOverride[stopObject[out.gtfsHead.stops.stop_id]]?properties.n=out.config.stopOverride[stopObject[out.gtfsHead.stops.stop_id]].stop_code:-1!==out.gtfsHead.stops.stop_code&&(properties.n=stopObject[out.gtfsHead.stops.stop_code].trim()),"n"in properties&&""!==properties.n&&("r"in out.aquius.node[index][2]?!1===withinKeys(properties,out.aquius.node[index][2].r)&&out.aquius.node[index][2].r.push(properties):out.aquius.node[index][2].r=[properties])),out}function stopCoordinates(out,stopsObject){var precision=Math.pow(10,out.config.coordinatePrecision);function parseCoord(value,precision){var numericValue=parseFloat(value);return Number.isNaN(numericValue)?0:Math.round(numericValue*precision)/precision}return-1!==out.gtfsHead.stops.stop_id&&stopsObject[out.gtfsHead.stops.stop_id]in out.config.stopOverride&&"x"in out.config.stopOverride[stopsObject[out.gtfsHead.stops.stop_id]]&&"y"in out.config.stopOverride[stopsObject[out.gtfsHead.stops.stop_id]]?[parseCoord(out.config.stopOverride[stopsObject[out.gtfsHead.stops.stop_id]].x,precision),parseCoord(out.config.stopOverride[stopsObject[out.gtfsHead.stops.stop_id]].y,precision)]:-1!==out.gtfsHead.stops.stop_lat&&-1!==out.gtfsHead.stops.stop_lon?[parseCoord(stopsObject[out.gtfsHead.stops.stop_lon],precision),parseCoord(stopsObject[out.gtfsHead.stops.stop_lat],precision)]:[0,0]}function checkStopCoordinates(out,coords,stopId){return 0===coords[0]&&0===coords[1]&&(stopId in out.config.stopOverride==!1&&(out.config.stopOverride[stopId]={}),out.config.stopOverride[stopId].x=0,out.config.stopOverride[stopId].y=0),out}function getGtfsTimeSeconds(timeString){var conversion,i,timeArray=timeString.split(":");if(3!==timeArray.length)return 0;for(i=0;i<timeArray.length;i+=1){if(conversion=parseInt(timeArray[i],10),Number.isNaN(conversion))return 0;timeArray[i]=conversion}return 3600*timeArray[0]+60*timeArray[1]+timeArray[2]}function isPointInFeature(x,y,feature){var i;function isPointInPolygon(x,y,polygonArray){var inside,xj,xk,yj,yk,i,j,k;if(Array.isArray(polygonArray))for(i=0;i<polygonArray.length;i+=1)if(Array.isArray(polygonArray[i])){for(inside=!1,j=0,k=polygonArray[i].length-1;j<polygonArray[i].length;k=j++)xj=polygonArray[i][j][0],yj=polygonArray[i][j][1],xk=polygonArray[i][k][0],yj>y!=(yk=polygonArray[i][k][1])>y&&x<(xk-xj)*(y-yj)/(yk-yj)+xj&&(inside=!inside);if(inside&&0===i&&1===polygonArray.length)return!0;if(!1===inside&&0===i)return!1;if(inside&&i>0)return!1;if(i===polygonArray.length-1)return!0}return!1}if("geometry"in feature==!1||"type"in feature.geometry==!1||"coordinates"in feature.geometry==!1||!Array.isArray(feature.geometry.coordinates))return!1;if("MultiPolygon"===feature.geometry.type)for(i=0;i<feature.geometry.coordinates.length;i+=1)if(isPointInPolygon(x,y,feature.geometry.coordinates[i]))return!0;return"Polygon"===feature.geometry.type&&isPointInPolygon(x,y,feature.geometry.coordinates)}function getCentroidFromFeature(feature){var i,bounds={};function getCentroidFromPolygon(polygonArray,bounds){var i,j;if(Array.isArray(polygonArray))for(i=0;i<polygonArray.length;i+=1)if(Array.isArray(polygonArray[i]))for(j=0;j<polygonArray[i].length;j+=1)Array.isArray(polygonArray[i][j])&&2===polygonArray[i][j].length&&("maxX"in bounds==!1?(bounds.maxX=polygonArray[i][j][0],bounds.minX=polygonArray[i][j][0],bounds.maxY=polygonArray[i][j][1],bounds.minY=polygonArray[i][j][1]):(polygonArray[i][j][0]>bounds.maxX?bounds.maxX=polygonArray[i][j][0]:polygonArray[i][j][0]<bounds.minX&&(bounds.minX=polygonArray[i][j][0]),polygonArray[i][j][1]>bounds.maxY?bounds.maxY=polygonArray[i][j][1]:polygonArray[i][j][1]<bounds.minY&&(bounds.minY=polygonArray[i][j][1])));return bounds}if("geometry"in feature&&"type"in feature.geometry&&"coordinates"in feature.geometry&&Array.isArray(feature.geometry.coordinates)){if("MultiPolygon"===feature.geometry.type)for(i=0;i<feature.geometry.coordinates.length;i+=1)bounds=getCentroidFromPolygon(feature.geometry.coordinates[i],bounds);"Polygon"===feature.geometry.type&&(bounds=getCentroidFromPolygon(feature.geometry.coordinates,bounds))}return"maxX"in bounds?[(bounds.maxX+bounds.minX)/2,(bounds.maxY+bounds.minY)/2]:null}function exitProcess(out,options){var error;return delete out._,delete out.gtfs,delete out.gtfsHead,"object"==typeof options&&"callback"in options?("error"in out&&(error=new Error(out.error.join(". "))),options.callback(error,out,options),!0):out}return out=function(out,options){var i,defaults={allowBlock:!1,allowDuration:!1,allowCabotage:!1,allowCode:!0,allowColor:!0,allowDuplication:!1,allowHeadsign:!1,allowName:!0,allowNoc:!1,allowRoute:!0,allowRouteLong:!1,allowRouteUrl:!0,allowSplit:!1,allowStopUrl:!0,allowWaypoint:!0,allowZeroCoordinate:!0,coordinatePrecision:5,duplicationRouteOnly:!0,fromDate:formatGtfsDate(Date.now()),inGeojson:!0,isCircular:[],meta:{schema:"0"},mirrorLink:!0,networkFilter:{type:"agency"},nodeGeojson:{},option:{},populationProperty:"population",placeNameProperty:"name",productOverride:{},routeExclude:[],routeInclude:[],routeOverride:{},serviceFilter:{},servicePer:1,splitMinimumJoin:2,stopExclude:[],stopInclude:[],stopOverride:{},stopPlace:!1,toDate:formatGtfsDate(Date.now()+5184e5),translation:{}},keys=Object.keys(defaults);for("object"!=typeof options&&(options={}),i=0;i<keys.length;i+=1)"config"in options&&keys[i]in options.config&&typeof options.config[keys[i]]==typeof defaults[keys[i]]?out.config[keys[i]]=options.config[keys[i]]:out.config[keys[i]]=defaults[keys[i]];for(out._.circular={},i=0;i<out.config.isCircular.length;i+=1)out._.circular[out.config.isCircular[i]]=out.config.isCircular[i];return out}(out,options),out=function(out,gtfs){var keys,i;out.gtfsIndex={stop_times:"trip_id"},out.gtfsHead={agency:{agency_id:-1,agency_name:-1,agency_noc:-1},calendar:{service_id:-1,monday:-1,tuesday:-1,wednesday:-1,thursday:-1,friday:-1,saturday:-1,sunday:-1,start_date:-1,end_date:-1},calendar_dates:{service_id:-1,date:-1,exception_type:-1},frequencies:{trip_id:-1,start_time:-1,end_time:-1,headway_secs:-1},routes:{agency_id:-1,route_color:-1,route_id:-1,route_long_name:-1,route_short_name:-1,route_text_color:-1,route_url:-1},stop_times:{arrival_time:-1,departure_time:-1,trip_id:-1,stop_id:-1,stop_sequence:-1,pickup_type:-1,drop_off_type:-1},stops:{stop_code:-1,stop_id:-1,stop_lat:-1,stop_lon:-1,stop_name:-1,stop_url:-1,location_type:-1,parent_station:-1},transfers:{from_stop_id:-1,to_stop_id:-1,transfer_type:-1},trips:{block_id:-1,direction_id:-1,route_id:-1,service_id:-1,trip_headsign:-1,trip_id:-1,trip_short_name:-1}},out.gtfsRequired={routes:["route_id"],stops:["stop_id","stop_lat","stop_lon"],trips:["route_id","service_id","trip_id"],stop_times:["trip_id","stop_id","stop_sequence"]},"type"in out.config.networkFilter&&"mode"===out.config.networkFilter.type&&(out.gtfsHead.routes.route_type=-1),"name"in out.config.meta!=!1&&"en-US"in out.config.meta.name!=!1||("feed_info"in out.gtfsHead==!1&&(out.gtfsHead.feed_info={}),out.gtfsHead.feed_info.feed_publisher_name=-1),"url"in out.config.meta==!1&&("feed_info"in out.gtfsHead==!1&&(out.gtfsHead.feed_info={}),out.gtfsHead.feed_info.feed_publisher_url=-1),keys=Object.keys(out.gtfsRequired);for(i=0;i<keys.length;i+=1)if(keys[i]in gtfs==!1)return"error"in out==!1&&(out.error=[]),out.error.push("Missing GTFS "+keys[i]+".txt"),out;for(out.gtfs={},keys=Object.keys(out.gtfsHead),i=0;i<keys.length;i+=1)keys[i]in gtfs&&(out=parseCsv(out,keys[i],gtfs[keys[i]]));return out}(out,gtfs),gtfs=null,"error"in out||(out=function(out,options){var centroid,checked,content,distance,index,key,keys,lastDiff,minDistance,node,population,xyDiff,i,j,centroidLookup={},centroidStack={},centroidKeys=[],nodeStack=[],thisPlace=-1,precision=Math.pow(10,out.config.coordinatePrecision),previousPlace=0,placeCoordStack={},placeStack={},maxPopulation=0,removeNode={};if(out.aquius.place=[],"object"==typeof options&&"geojson"in options&&"type"in options.geojson&&"FeatureCollection"===options.geojson.type&&"features"in options.geojson&&Array.isArray(options.geojson.features)&&options.geojson.features.length>0){for(i=0;i<options.geojson.features.length;i+=1)null!==(centroid=getCentroidFromFeature(options.geojson.features[i]))&&(centroidKeys.push(i),centroidStack[i]={x:Math.round(centroid[0]*precision)/precision,y:Math.round(centroid[1]*precision)/precision},centroidLookup[centroidStack[i].x+":"+centroidStack[i].y]=i);for(i=0;i<out.aquius.node.length;i+=1)nodeStack.push([out.aquius.node[i][0]+out.aquius.node[i][1],i]);for(nodeStack.sort(),i=0;i<nodeStack.length;i+=1){if(thisPlace=-1,(key=(node=out.aquius.node[nodeStack[i][1]])[0]+":"+node[1])in out.config.nodeGeojson&&out.config.nodeGeojson[key]in centroidLookup&&(thisPlace=centroidLookup[out.config.nodeGeojson[key]]),-1===thisPlace&&isPointInFeature(node[0],node[1],options.geojson.features[previousPlace])&&(thisPlace=previousPlace),-1===thisPlace){for((checked={})[previousPlace]=previousPlace,j=0;j<centroidKeys.length;j+=1)if(xyDiff=Math.abs(node[0]+node[1]-(centroidStack[centroidKeys[j]].x+centroidStack[centroidKeys[j]].y)),0===j&&(lastDiff=xyDiff),lastDiff>=xyDiff&&centroidKeys[j]in checked==!1){if(isPointInFeature(node[0],node[1],options.geojson.features[centroidKeys[j]])){thisPlace=centroidKeys[j];break}checked[centroidKeys[j]]=centroidKeys[j],Object.keys(checked).length<5&&(lastDiff=xyDiff)}if(-1===thisPlace)for(j=0;j<options.geojson.features.length;j+=1)if(j in checked==!1&&isPointInFeature(node[0],node[1],options.geojson.features[j])){thisPlace=j;break}if(-1===thisPlace&&!1===out.config.inGeojson)for(minDistance=-1,j=0;j<centroidKeys.length;j+=1)distance=haversineDistance(node[1],node[0],centroidStack[centroidKeys[j]].y,centroidStack[centroidKeys[j]].x),(-1===minDistance||distance<minDistance)&&(minDistance=distance,thisPlace=j)}-1!==thisPlace?(previousPlace=thisPlace,thisPlace in placeStack?out.aquius.node[nodeStack[i][1]][2].p=placeStack[thisPlace]:thisPlace in centroidStack&&((key=[centroidStack[thisPlace].x,centroidStack[thisPlace].y].join(":"))in placeCoordStack?index=placeCoordStack[key]:(out.aquius.place.push([centroidStack[thisPlace].x,centroidStack[thisPlace].y,{}]),index=out.aquius.place.length-1,placeCoordStack[key]=index),out.aquius.node[nodeStack[i][1]][2].p=index,placeStack[thisPlace]=index,"properties"in options.geojson.features[thisPlace]&&out.config.populationProperty in options.geojson.features[thisPlace].properties&&(population=parseFloat(options.geojson.features[thisPlace].properties[out.config.populationProperty]),Number.isNaN(population)||("p"in out.aquius.place[index][2]==!1&&(out.aquius.place[index][2].p=0),out.aquius.place[index][2].p+=population,out.aquius.place[index][2].p>maxPopulation&&(maxPopulation=out.aquius.place[index][2].p))),"properties"in options.geojson.features[thisPlace]&&out.config.placeNameProperty in options.geojson.features[thisPlace].properties&&null!==options.geojson.features[thisPlace].properties[out.config.placeNameProperty]&&((content={}).n=options.geojson.features[thisPlace].properties[out.config.placeNameProperty].trim(),""!==content.n&&("r"in out.aquius.place[index][2]==!1&&(out.aquius.place[index][2].r=[]),out.aquius.place[index][2].r.push(content)))),thisPlace in centroidStack&&(out.config.nodeGeojson[node[0]+":"+node[1]]=centroidStack[thisPlace].x+":"+centroidStack[thisPlace].y)):!0===out.config.inGeojson&&(removeNode[nodeStack[i][1]]="")}if(maxPopulation>0&&"placeScale"in out.config.option==!1&&(out.config.option.placeScale=Math.round(1/(maxPopulation/2e6)*1e5)/1e5,"option"in out.aquius==!1&&(out.aquius.option={}),out.aquius.option.placeScale=out.config.option.placeScale),Object.keys(removeNode).length>0)for(keys=Object.keys(out._.nodeLookup),i=0;i<keys.length;i+=1)out._.nodeLookup[keys[i]]in removeNode&&delete out._.nodeLookup[keys[i]]}return out}(out=function(out){var coords,index,key,i;"nodeLookup"in out._==!1&&(out._.nodeLookup={}),"nodeCoord"in out._==!1&&(out._.nodeCoord={}),"node"in out.aquius==!1&&(out.aquius.node=[]);for(i=0;i<out.gtfs.stops.length;i+=1)out.gtfs.stops[i].stop_id in out._.nodeLookup!=!1||""===out.gtfs.stops[i][out.gtfsHead.stops.stop_id]||"stopExclude"in out._!=!1&&out.gtfs.stops[i][out.gtfsHead.stops.stop_id]in out._.stopExclude!=!1||"stopInclude"in out._!=!1&&!(out.gtfs.stops[i][out.gtfsHead.stops.stop_id]in out._.stopInclude)||(coords=stopCoordinates(out,out.gtfs.stops[i]),(out.config.allowZeroCoordinate||0!==coords[0]||0!==coords[1])&&(out=checkStopCoordinates(out,coords,out.gtfs.stops[i][out.gtfsHead.stops.stop_id]),(key=coords[0].toString()+","+coords[1].toString())in out._.nodeCoord?index=out._.nodeCoord[key]:(index=out.aquius.node.length,out.aquius.node.push([coords[0],coords[1],{}]),out._.nodeCoord[key]=index),out._.nodeLookup[out.gtfs.stops[i][out.gtfsHead.stops.stop_id]]=index,out=createNodeProperties(out,out.gtfs.stops[i],index)));return delete out._.nodeCoord,out}(out=function(out){var coords,index,key,fromStop,toStop,i,j;if("transfers"in out.gtfs&&-1!==out.gtfsHead.transfers.from_stop_id&&-1!==out.gtfsHead.transfers.to_stop_id&&1!==out.gtfsHead.transfers.transfer_type){"nodeLookup"in out._==!1&&(out._.nodeLookup={}),"nodeCoord"in out._==!1&&(out._.nodeCoord={}),"node"in out.aquius==!1&&(out.aquius.node=[]);for(i=0;i<out.gtfs.transfers.length;i+=1)if(""!==out.gtfs.transfers[i][out.gtfsHead.transfers.from_stop_id]&&("stopExclude"in out._==!1||out.gtfs.transfers[i][out.gtfsHead.transfers.from_stop_id]in out._.stopExclude==!1&&out.gtfs.transfers[i][out.gtfsHead.transfers.to_stop_id]in out._.stopExclude==!1)&&("stopInclude"in out._==!1||out.gtfs.transfers[i][out.gtfsHead.transfers.from_stop_id]in out._.stopInclude&&out.gtfs.transfers[i][out.gtfsHead.transfers.to_stop_id]in out._.stopInclude)&&(fromStop=out._.nodeLookup[out.gtfs.transfers[i][out.gtfsHead.transfers.from_stop_id]])!==(toStop=out._.nodeLookup[out.gtfs.transfers[i][out.gtfsHead.transfers.to_stop_id]]))if(void 0!==fromStop&&void 0!==toStop);else if(void 0!==fromStop)out._.nodeLookup[toStop]=fromStop;else if(void 0!==toStop)out._.nodeLookup[fromStop]=toStop;else if(void 0===fromStop&&void 0===toStop)for(j=0;j<out.gtfs.stops.length;j+=1)if(out.gtfs.stops[j][out.gtfsHead.stops.stop_id]===fromStop&&(coords=stopCoordinates(out,out.gtfs.stops[j]),out.config.allowZeroCoordinate||0!==coords[0]||0!==coords[1])){out=checkStopCoordinates(out,coords,out.gtfs.stops[j][out.gtfsHead.stops.stop_id]),(key=coords[0].toString()+","+coords[1].toString())in out._.nodeCoord?index=out._.nodeCoord[key]:(index=out.aquius.node.length,out.aquius.node.push([coords[0],coords[1],{}]),out._.nodeCoord[key]=index),out._.nodeLookup[fromStop]=index,out._.nodeLookup[toStop]=index,out=createNodeProperties(out,out.gtfs.stops[j],index);break}}return out}(out=function(out){var coords,index,key,i,childStops=[];if(-1!==out.gtfsHead.stops.location_type&&-1!==out.gtfsHead.stops.parent_station){"nodeLookup"in out._==!1&&(out._.nodeLookup={}),"nodeCoord"in out._==!1&&(out._.nodeCoord={}),"node"in out.aquius==!1&&(out.aquius.node=[]);for(i=0;i<out.gtfs.stops.length;i+=1)"stopExclude"in out._!=!1&&out.gtfs.stops[i][out.gtfsHead.stops.stop_id]in out._.stopExclude!=!1||"stopInclude"in out._!=!1&&!(out.gtfs.stops[i][out.gtfsHead.stops.stop_id]in out._.stopInclude)||("1"===out.gtfs.stops[i][out.gtfsHead.stops.location_type]?(coords=stopCoordinates(out,out.gtfs.stops[i]),(out.config.allowZeroCoordinate||0!==coords[0]||0!==coords[1])&&(out=checkStopCoordinates(out,coords,out.gtfs.stops[i][out.gtfsHead.stops.stop_id]),(key=coords[0].toString()+","+coords[1].toString())in out._.nodeCoord?index=out._.nodeCoord[key]:(index=out.aquius.node.length,out.aquius.node.push([coords[0],coords[1],{}]),out._.nodeCoord[key]=index),out._.nodeLookup[out.gtfs.stops[i][out.gtfsHead.stops.stop_id]]=index,out=createNodeProperties(out,out.gtfs.stops[i],index))):""!==out.gtfs.stops[i][out.gtfsHead.stops.parent_station]&&childStops.push([out.gtfs.stops[i][out.gtfsHead.stops.stop_id],out.gtfs.stops[i][out.gtfsHead.stops.parent_station]]));for(i=0;i<childStops.length;i+=1)childStops[i][1]in out._.nodeLookup&&(out._.nodeLookup[childStops[i][0]]=out._.nodeLookup[childStops[i][1]])}return out}(out=function(out){var i;if(out.config.stopExclude.length>0)for(out._.stopExclude={},i=0;i<out.config.stopExclude.length;i+=1)out._.stopExclude[out.config.stopExclude[i]]="";if(out.config.stopInclude.length>0)for(out._.stopInclude={},i=0;i<out.config.stopInclude.length;i+=1)out._.stopInclude[out.config.stopInclude[i]]="";return out}(out=function(out){var weekdays,i;if("serviceFilter"in out.config&&"type"in out.config.serviceFilter&&"period"===out.config.serviceFilter.type){"period"in out.config.serviceFilter!=!1&&Array.isArray(out.config.serviceFilter.period)&&0!==out.config.serviceFilter.period.length||(weekdays=["monday","tuesday","wednesday","thursday","friday"],out.config.serviceFilter.period=[{name:{"en-US":"Typical day"}},{day:weekdays,name:{"en-US":"Typical weekday"}},{day:weekdays,name:{"en-US":"Weekday early"},time:[{end:"10:00:00"}]},{day:weekdays,name:{"en-US":"Weekday 10:00-17:00"},time:[{start:"10:00:00",end:"17:00:00"}]},{day:weekdays,name:{"en-US":"Weekday evening"},time:[{start:"17:00:00"}]},{day:["saturday"],name:{"en-US":"Saturday"}},{day:["sunday"],name:{"en-US":"Sunday"}}]),out.aquius.service=[];for(i=0;i<out.config.serviceFilter.period.length;i+=1)"name"in out.config.serviceFilter.period[i]==!1&&(out.config.serviceFilter.period[i].name={"en-US":"Period "+i}),out.aquius.service.push([[i],out.config.serviceFilter.period[i].name,{}])}return out}(out=function(out){var agencyColumn,index,keys,nameExtra,product,i,j,modeLookup={0:{"en-US":"Tram"},1:{"en-US":"Metro"},2:{"en-US":"Rail"},3:{"en-US":"Bus"},4:{"en-US":"Ferry"},5:{"en-US":"Cable car"},6:{"en-US":"Cable car"},7:{"en-US":"Funicular"},100:{"en-US":"Rail"},101:{"en-US":"High speed rail"},102:{"en-US":"Long distance rail"},103:{"en-US":"Inter-regional rail"},105:{"en-US":"Sleeper rail"},106:{"en-US":"Regional rail"},107:{"en-US":"Tourist rail"},108:{"en-US":"Rail shuttle"},109:{"en-US":"Suburban rail"},200:{"en-US":"Coach"},201:{"en-US":"International coach"},202:{"en-US":"National coach"},204:{"en-US":"Regional coach"},208:{"en-US":"Commuter coach"},400:{"en-US":"Urban rail"},401:{"en-US":"Metro"},402:{"en-US":"Underground"},405:{"en-US":"Monorail"},700:{"en-US":"Bus"},701:{"en-US":"Regional bus"},702:{"en-US":"Express bus"},704:{"en-US":"Local bus"},800:{"en-US":"Trolleybus"},900:{"en-US":"Tram"},1e3:{"en-US":"Water"},1300:{"en-US":"Telecabin"},1400:{"en-US":"Funicular"},1501:{"en-US":"Shared taxi"},1700:{"en-US":"Other"},1701:{"en-US":"Cable car"},1702:{"en-US":"Horse-drawn"}};if("type"in out.config.networkFilter==!1&&(out.config.networkFilter.type="agency"),"reference"in out.config.networkFilter==!1&&(out.config.networkFilter.reference={}),out._.productIndex={},"reference"in out.aquius==!1&&(out.aquius.reference={}),out.aquius.reference.product=[],"mode"===out.config.networkFilter.type){if("route_type"in out.gtfsHead.routes&&-1!==out.gtfsHead.routes.route_type&&out.gtfs.routes.length>0)for(index=0,i=0;i<out.gtfs.routes.length;i+=1)out.gtfs.routes[i][out.gtfsHead.routes.route_type]in out._.productIndex==!1&&(out._.productIndex[out.gtfs.routes[i][out.gtfsHead.routes.route_type]]=index,out.gtfs.routes[i][out.gtfsHead.routes.route_type]in out.config.networkFilter.reference==!1&&(out.gtfs.routes[i][out.gtfsHead.routes.route_type]in modeLookup?out.config.networkFilter.reference[out.gtfs.routes[i][out.gtfsHead.routes.route_type]]=modeLookup[out.gtfs.routes[i][out.gtfsHead.routes.route_type]]:out.config.networkFilter.reference[out.gtfs.routes[i][out.gtfsHead.routes.route_type]]={}),out.aquius.reference.product[index]=out.config.networkFilter.reference[out.gtfs.routes[i][out.gtfsHead.routes.route_type]],index+=1)}else{if(out.config.networkFilter.type="agency","agency"in out.gtfs&&("agency_id"in out.gtfsHead.agency&&-1!==out.gtfsHead.agency.agency_id||"agency_name"in out.gtfsHead.agency&&-1!==out.gtfsHead.agency.agency_name)&&out.gtfs.agency.length>0){index=0,agencyColumn="agency_id"in out.gtfsHead.agency&&-1!==out.gtfsHead.agency.agency_id?out.gtfsHead.agency.agency_id:out.gtfsHead.agency.agency_name;for(i=0;i<out.gtfs.agency.length;i+=1)void 0!==out.gtfs.agency[i][agencyColumn]&&""!==out.gtfs.agency[i][agencyColumn]&&out.gtfs.agency[i][agencyColumn]in out._.productIndex==!1&&(out._.productIndex[out.gtfs.agency[i][agencyColumn]]=index,out.gtfs.agency[i][agencyColumn]in out.config.networkFilter.reference==!1&&(nameExtra=!0===out.config.allowNoc&&-1!==out.gtfsHead.agency.agency_noc?" ["+out.gtfs.agency[i][out.gtfsHead.agency.agency_noc]+"]":"",-1!==out.gtfsHead.agency.agency_name?out.config.networkFilter.reference[out.gtfs.agency[i][agencyColumn]]={"en-US":out.gtfs.agency[i][out.gtfsHead.agency.agency_name]+nameExtra}:out.config.networkFilter.reference[out.gtfs.agency[i][agencyColumn]]={"en-US":out.gtfs.agency[i][out.gtfsHead.agency.agency_id]+nameExtra}),out.aquius.reference.product[index]=out.config.networkFilter.reference[out.gtfs.agency[i][agencyColumn]],index+=1)}0===Object.keys(out._.productIndex).length&&(out._.productIndex.agency=0,out.config.networkFilter.reference.agency={},out.aquius.reference.product[0]={})}if("network"in out.config.networkFilter==!1||!Array.isArray(out.config.networkFilter.network))switch(out.config.networkFilter.network=[],keys=Object.keys(out._.productIndex),out.config.networkFilter.type){case"mode":if(out.config.networkFilter.network.push([keys,{"en-US":"All modes"}]),keys.length>1)for(i=0;i<keys.length;i+=1)keys[i]in modeLookup?out.config.networkFilter.network.push([[keys[i]],modeLookup[keys[i]]]):out.config.networkFilter.network.push([[keys[i]],{"en-US":"Mode #"+keys[i]}]);break;case"agency":if(out.config.networkFilter.network.push([keys,{"en-US":"All operators"}]),keys.length>1)for(i=0;i<keys.length;i+=1)if("agency"in out.gtfs&&-1!==out.gtfsHead.agency.agency_id&&-1!==out.gtfsHead.agency.agency_name){for(j=0;j<out.gtfs.agency.length;j+=1)if(out.gtfs.agency[j][out.gtfsHead.agency.agency_id]===keys[i]){nameExtra=!0===out.config.allowNoc&&-1!==out.gtfsHead.agency.agency_noc?" ["+out.gtfs.agency[j][out.gtfsHead.agency.agency_noc]+"]":"",out.config.networkFilter.network.push([[keys[i]],{"en-US":out.gtfs.agency[j][out.gtfsHead.agency.agency_name]+nameExtra}]);break}}else out.config.networkFilter.network.push([[keys[i]],{"en-US":keys[i]}]);break;default:out.config.networkFilter.network.push([keys,{"en-US":"All"}])}for(out.aquius.network=[],i=0;i<out.config.networkFilter.network.length;i+=1)if(out.config.networkFilter.network[i].length>1&&Array.isArray(out.config.networkFilter.network[i][0])&&"object"==typeof out.config.networkFilter.network[i][1]){for(product=[],j=0;j<out.config.networkFilter.network[i][0].length;j+=1)out.config.networkFilter.network[i][0][j]in out._.productIndex&&product.push(out._.productIndex[out.config.networkFilter.network[i][0][j]]);out.aquius.network.push([product,out.config.networkFilter.network[i][1],{}])}return out}(out=function(out){if("schema"in out.config.meta!=!1&&"0"===out.config.meta.schema||(out.config.meta.schema="0"),"name"in out.config.meta==!1&&(out.config.meta.name={}),"en-US"in out.config.meta.name==!1&&("feed_info"in out.gtfs&&-1!==out.gtfsHead.feed_info.feed_publisher_name&&out.gtfs.feed_info.length>0?out.config.meta.name["en-US"]=out.gtfs.feed_info[0][out.gtfsHead.feed_info.feed_publisher_name]+" ":out.config.meta.name["en-US"]="",out.config.meta.name["en-US"]+="("+out.config.fromDate,out.config.fromDate!==out.config.toDate&&(out.config.meta.name["en-US"]+="-"+out.config.toDate),out.config.meta.name["en-US"]+=")"),"url"in out.config.meta==!1&&"feed_info"in out.gtfs&&-1!==out.gtfsHead.feed_info.feed_publisher_url&&out.gtfs.feed_info.length>0&&(out.config.meta.url=out.gtfs.feed_info[0][out.gtfsHead.feed_info.feed_publisher_url]),out.aquius.meta=out.config.meta,"en-US"in out.config.translation==!1&&(out.config.translation["en-US"]={}),"link"in out.config.translation["en-US"]==!1)switch(out.config.servicePer){case 1:out.config.translation["en-US"].link="Daily Services";break;case 7:out.config.translation["en-US"].link="Weekly Services";break;default:out.config.translation["en-US"].link="Services per "+out.config.servicePer+" Days"}return out.aquius.translation=out.config.translation,"c"in out.config.option!=!1&&"k"in out.config.option!=!1||(out.config.option.c=parseFloat(out.gtfs.stops[0][out.gtfsHead.stops.stop_lon]),out.config.option.k=parseFloat(out.gtfs.stops[0][out.gtfsHead.stops.stop_lat]),out.config.option.m=12),"x"in out.config.option!=!1&&"y"in out.config.option!=!1||(out.config.option.x=parseFloat(out.gtfs.stops[0][out.gtfsHead.stops.stop_lon]),out.config.option.y=parseFloat(out.gtfs.stops[0][out.gtfsHead.stops.stop_lat]),out.config.option.z=10),out.aquius.option=out.config.option,out}(out))))))),options),out=function(out,options){if("summary"in out&&"service"in out.summary&&out.summary.service.length>0){let tableData,tableFormat,tableHeader,tableRow,prefix,i,j;if(prefix="_vars"in options&&"configId"in options._vars?options._vars.configId:"",tableHeader=["Hour"],tableFormat=[prefix+"Number"],"service"in out.aquius==!1||0===out.aquius.service.length)tableHeader.push("All"),tableFormat.push(prefix+"Number");else for(i=0;i<out.aquius.service.length;i+=1)"en-US"in out.aquius.service[i][1]?tableHeader.push(out.aquius.service[i][1]["en-US"]):tableHeader.push(JSON.stringify(out.aquius.service[i][1])),tableFormat.push(prefix+"Number");for(tableData=[],i=0;i<out.summary.service.length;i+=1){if(tableRow=[i],void 0===out.summary.service[i])if("service"in out.aquius==!1||0===out.aquius.service.length)tableRow.push("-");else for(j=0;j<out.aquius.service.length;j+=1)tableRow.push("-");else for(j=0;j<out.summary.service[i].length;j+=1)out.summary.service[i][j]>0?tableRow.push((100*out.summary.service[i][j]).toFixed(2)):tableRow.push("-");tableData.push(tableRow)}out.summaryTable={data:tableData,format:tableFormat,header:tableHeader}}return out}(out=function(out){let keys,zeroCoord,i;if("stopOverride"in out.config){for(keys=Object.keys(out.config.stopOverride),zeroCoord=[],i=0;i<keys.length;i+=1)"x"in out.config.stopOverride[keys[i]]&&0===out.config.stopOverride[keys[i]].x&&"y"in out.config.stopOverride[keys[i]]&&0===out.config.stopOverride[keys[i]].y&&zeroCoord.push(keys[i]);zeroCoord.length>0&&("warning"in out==!1&&(out.warning=[]),out.warning.push("Caution: Contains "+zeroCoord.length.toString()+" stop_id with coordinates 0,0, which can be corrected in config.stopOverride, or ignored by setting config.allowZeroCoordinate to false."))}return out}(out=function(out){var keys,newNode,newNodeLookup,nodeArray,i,j,nodeOccurance={};for(i=0;i<out.aquius.link.length;i+=1){nodeArray=out.aquius.link[i][2],"u"in out.aquius.link[i][3]&&(nodeArray=nodeArray.concat(out.aquius.link[i][3].u)),"s"in out.aquius.link[i][3]&&(nodeArray=nodeArray.concat(out.aquius.link[i][3].s)),"t"in out.aquius.link[i][3]&&(nodeArray=nodeArray.concat(out.aquius.link[i][3].t));for(j=0;j<nodeArray.length;j+=1)nodeArray[j]in nodeOccurance==!1?nodeOccurance[nodeArray[j]]=1:nodeOccurance[nodeArray[j]]+=1}for(nodeArray=[],keys=Object.keys(nodeOccurance),i=0;i<keys.length;i+=1)nodeArray.push([nodeOccurance[keys[i]],keys[i]]);for(nodeArray.sort((function(a,b){return a[0]-b[0]})),nodeArray.reverse(),newNode=[],newNodeLookup={},i=0;i<nodeArray.length;i+=1)newNode.push(out.aquius.node[nodeArray[i][1]]),newNodeLookup[nodeArray[i][1]]=i;for(out.aquius.node=newNode,i=0;i<out.aquius.link.length;i+=1){for(j=0;j<out.aquius.link[i][2].length;j+=1)out.aquius.link[i][2][j]=newNodeLookup[out.aquius.link[i][2][j]];if("u"in out.aquius.link[i][3])for(j=0;j<out.aquius.link[i][3].u.length;j+=1)out.aquius.link[i][3].u[j]=newNodeLookup[out.aquius.link[i][3].u[j]];if("s"in out.aquius.link[i][3])for(j=0;j<out.aquius.link[i][3].s.length;j+=1)out.aquius.link[i][3].s[j]=newNodeLookup[out.aquius.link[i][3].s[j]];if("t"in out.aquius.link[i][3])for(j=0;j<out.aquius.link[i][3].t.length;j+=1)out.aquius.link[i][3].t[j]=newNodeLookup[out.aquius.link[i][3].t[j]]}return out}(out=function(out){var add,backward,blockNodes,check,forward,isBackward,keys,line,merge,nodeCount,nodes,nodeStack,reference,routeId,stops,thisLink,trips,i,j,k,l,link={},skipTrip={};function isCircular(out,routeId,trip,nodes){var check,stops,target,i,j;if(out.config.isCircular.length>0)return routeId in out._.circular;if(nodes.length<3||nodes[0]!==nodes[nodes.length-1])return!1;if("block"in trip&&trip.block.trips.length>1){for(target=nodes.join(":"),check=null,i=0;i<trip.block.trips.length;i+=1)if(trip.block.trips[i]in out._.trip){for(stops=out._.trip[trip.block.trips[i]].stops.slice().sort((function(a,b){return a[0]-b[0]})),check=[],j=0;j<stops.length;j+=1)check.push(stops[j][1]);if(check.join(":")!==target){check=null;break}}if(null!==check)return!0}return!(nodes.length<5)&&haversineDistance(out.aquius.node[nodes[1]][1],out.aquius.node[nodes[1]][0],out.aquius.node[nodes[nodes.length-2]][1],out.aquius.node[nodes[nodes.length-2]][0])>200}function mergeService(serviceA,serviceB){var service,i;if(1===serviceA.length&&serviceA.length===serviceB.length)return[serviceA[0]+serviceB[0]];for(service=[],i=0;i<serviceA.length;i+=1)i<serviceB.length&&service.push(serviceA[i]+serviceB[i]);return service}function mergeDuration(minutesA,minutesB){var duration,i;if(minutesA===minutesB)return minutesA;for(duration=[],i=0;i<minutesA.length&&!(i>minutesB.length);i+=1)0===minutesB[i]?duration.push(minutesA[i]):0===minutesA[i]?duration.push(minutesB[i]):duration.push(Math.round((minutesA[i]+minutesB[i])/2));return duration}for(trips=Object.keys(out._.trip),i=0;i<trips.length;i+=1)if(routeId=out._.trip[trips[i]].route_id,trips[i]in skipTrip==!1&&routeId in out._.routes&&"product"in out._.routes[routeId]){if(isBackward=!1,nodes=[],nodeCount={},out._.trip[trips[i]].stops.sort((function(a,b){return a[0]-b[0]})),reference={},"reference"in out._.routes[routeId]&&out._.routes[routeId].reference.slug in reference==!1&&(reference[out._.routes[routeId].reference.slug]=out._.routes[routeId].reference),"reference"in out._.trip[trips[i]]&&out._.trip[trips[i]].reference.slug in reference==!1&&(reference[out._.trip[trips[i]].reference.slug]=out._.trip[trips[i]].reference),"block"in out._.trip[trips[i]]&&out._.trip[trips[i]].block.trips.length>1&&(0===out.config.isCircular.length||routeId in out._.circular==0)){for(merge=[],j=0;j<out._.trip[trips[i]].block.trips.length;j+=1)if(out._.trip[trips[i]].block.trips[j]in skipTrip==!1&&out._.trip[trips[i]].block.trips[j]in out._.trip&&out._.trip[out._.trip[trips[i]].block.trips[j]].service.join(":")===out._.trip[trips[i]].service.join(":")&&out._.trip[out._.trip[trips[i]].block.trips[j]].route_id in out._.routes&&out._.routes[out._.trip[out._.trip[trips[i]].block.trips[j]].route_id].product===out._.routes[routeId].product&&"start"in out._.trip[out._.trip[trips[i]].block.trips[j]]&&"end"in out._.trip[out._.trip[trips[i]].block.trips[j]]){for(stops=out._.trip[out._.trip[trips[i]].block.trips[j]].stops.sort((function(a,b){return a[0]-b[0]})),blockNodes=[],k=0;k<stops.length;k+=1)blockNodes.push(stops[k][1]);merge.push([(out._.trip[out._.trip[trips[i]].block.trips[j]].start+out._.trip[out._.trip[trips[i]].block.trips[j]].end)/2,blockNodes,out._.trip[trips[i]].block.trips[j]])}if(merge.length>1)for(merge.sort((function(a,b){return a[0]-b[0]})),j=0;j<merge.length;j+=1)if(merge[j][1].length>0&&(nodes.length>0&&merge[j][1][0]===nodes[nodes.length-1]&&(merge[j][1]=merge[j][1].slice(1)),nodes=nodes.concat(merge[j][1]),merge[j][2]!==trips[i])){for(skipTrip[merge[j][2]]="",check=["t","setdown","pickup"],k=0;k<check.length;k+=1)if(check[k]in out._.trip[merge[j][2]]){check[k]in out._.trip[trips[i]]==!1&&(out._.trip[trips[i]][check[k]]=[]);for(l=0;l<out._.trip[merge[j][2]][check[k]].length;l+=1)-1===out._.trip[trips[i]][check[k]].indexOf(out._.trip[merge[j][2]][check[k]][l])&&out._.trip[trips[i]][check[k]].push(out._.trip[merge[j][2]][check[k]][l])}out._.trip[merge[j][2]].route_id in out._.routes&&"reference"in out._.routes[out._.trip[merge[j][2]].route_id]&&out._.routes[out._.trip[merge[j][2]].route_id].reference.slug in reference==!1&&(reference[out._.routes[out._.trip[merge[j][2]].route_id].reference.slug]=out._.routes[out._.trip[merge[j][2]].route_id].reference),"reference"in out._.trip[merge[j][2]]&&out._.trip[merge[j][2]].reference.slug in reference==!1&&(reference[out._.trip[merge[j][2]].reference.slug]=out._.trip[merge[j][2]].reference)}}forward="f"+out._.routes[routeId].product,out.config.mirrorLink&&(backward="f"+out._.routes[routeId].product),"setdown"in out._.trip[trips[i]]&&out._.trip[trips[i]].setdown.length>0&&(out._.trip[trips[i]].setdown.sort(),forward+="s"+out._.trip[trips[i]].setdown.join(":")),"pickup"in out._.trip[trips[i]]&&out._.trip[trips[i]].pickup.length>0&&(out._.trip[trips[i]].pickup.sort(),forward+="u"+out._.trip[trips[i]].pickup.join(":"),out.config.mirrorLink&&(backward+="s"+out._.trip[trips[i]].pickup.join(":"))),out.config.mirrorLink&&"setdown"in out._.trip[trips[i]]&&out._.trip[trips[i]].setdown.length>0&&(backward+="u"+out._.trip[trips[i]].setdown.join(":")),"t"in out._.trip[trips[i]]&&(forward+="t"+out._.trip[trips[i]].t.join(":"),out.config.mirrorLink&&(backward+="t"+out._.trip[trips[i]].t.join(":"))),add=0===nodes.length;for(j=0;j<out._.trip[trips[i]].stops.length;j+=1)add&&nodes.push(out._.trip[trips[i]].stops[j][1]),out._.trip[trips[i]].stops[j][1]in nodeCount?nodeCount[out._.trip[trips[i]].stops[j][1]]+=1:nodeCount[out._.trip[trips[i]].stops[j][1]]=1;if(out.config.mirrorLink&&(backward=nodes.slice().reverse().join(":")+backward),(forward=nodes.join(":")+forward)in link&&"b"in out._.trip[trips[i]]==!1)link[forward].service=mergeService(link[forward].service,out._.trip[trips[i]].service),"minutes"in link[forward]&&"minutes"in out._.trip[trips[i]]&&(link[forward].minutes=mergeDuration(link[forward].minutes,out._.trip[trips[i]].minutes));else if(out.config.mirrorLink&&backward in link&&"b"in out._.trip[trips[i]]==!1)isBackward=!0,link[backward].service=mergeService(link[backward].service,out._.trip[trips[i]].service),"minutes"in link[backward]&&"minutes"in out._.trip[trips[i]]&&(link[backward].minutes=mergeDuration(link[backward].minutes,out._.trip[trips[i]].minutes)),"direction"in link[backward]&&delete link[backward].direction;else{if(link[forward]={direction:1,product:out._.routes[routeId].product,route:nodes,service:out._.trip[trips[i]].service},"minutes"in out._.trip[trips[i]]&&(link[forward].minutes=out._.trip[trips[i]].minutes),"setdown"in out._.trip[trips[i]]){for(nodeStack=[],j=0;j<out._.trip[trips[i]].setdown.length;j+=1)out._.trip[trips[i]].setdown[j]in nodeCount&&1===nodeCount[out._.trip[trips[i]].setdown[j]]&&nodeStack.push(out._.trip[trips[i]].setdown[j]);nodeStack.length>0&&(link[forward].setdown=nodeStack)}if("pickup"in out._.trip[trips[i]]){for(nodeStack=[],j=0;j<out._.trip[trips[i]].pickup.length;j+=1)out._.trip[trips[i]].pickup[j]in nodeCount&&1===nodeCount[out._.trip[trips[i]].pickup[j]]&&nodeStack.push(out._.trip[trips[i]].pickup[j]);nodeStack.length>0&&(link[forward].pickup=nodeStack)}if(isCircular(out,routeId,out._.trip[trips[i]],nodes)&&(link[forward].circular=1),"b"in out._.trip[trips[i]]&&(link[forward].b=out._.trip[trips[i]].b),"t"in out._.trip[trips[i]]){for(nodeStack=[],j=0;j<out._.trip[trips[i]].t.length;j+=1)out._.trip[trips[i]].t[j]in nodeCount&&1===nodeCount[out._.trip[trips[i]].t[j]]&&nodeStack.push(out._.trip[trips[i]].t[j]);nodeStack.length>0&&(link[forward].t=nodeStack)}}if((keys=Object.keys(reference)).length>0){isBackward&&"reference"in link[backward]==!1&&(link[backward].reference=[],link[backward].referenceLookup={}),0==isBackward&&"reference"in link[forward]==!1&&(link[forward].reference=[],link[forward].referenceLookup={});for(j=0;j<keys.length;j+=1)isBackward&&keys[j]in link[backward].referenceLookup==!1&&(link[backward].reference.push(reference[keys[j]]),link[backward].referenceLookup[keys[j]]=""),!1===isBackward&&keys[j]in link[forward].referenceLookup==!1&&(link[forward].reference.push(reference[keys[j]]),link[forward].referenceLookup[keys[j]]="")}}for(delete out._.nodeLookup,delete out._.routes,delete out._.trip,out.aquius.link=[],out.summary.network=[],i=0;i<out.aquius.network.length;i+=1)if("service"in out.aquius)for(out.summary.network.push([]),j=0;j<out.aquius.service.length;j+=1)out.summary.network[i].push(0);else out.summary.network.push([0]);for(keys=Object.keys(link),i=0;i<keys.length;i+=1){for(thisLink=link[keys[i]],j=0;j<thisLink.service.length;j+=1){for(k=0;k<out.aquius.network.length;k+=1)-1!==out.aquius.network[k][0].indexOf(thisLink.product)&&(out.summary.network[k][j]+=thisLink.service[j]);thisLink.service[j]<10?thisLink.service[j]=parseFloat(thisLink.service[j].toPrecision(1)):thisLink.service[j]=parseInt(thisLink.service[j],10)}if(!1===out.config.allowWaypoint&&"pickup"in thisLink&&"setdown"in thisLink)for(j=thisLink.pickup.length-1;j>=0;j--)if(-1!==(check=thisLink.setdown.indexOf(thisLink.pickup[j]))){for(k=thisLink.route.length-1;k>=0;k--)thisLink.route[k]===thisLink.pickup[j]&&thisLink.route.splice(k,1);thisLink.pickup.splice(j,1),thisLink.setdown.splice(check,1)}if(line=[[thisLink.product],thisLink.service,thisLink.route,{}],"reference"in thisLink){for(j=0;j<thisLink.reference.length;j+=1)delete thisLink.reference[j].slug;line[3].r=thisLink.reference}"color"in thisLink&&(line[3].o=thisLink.color),"circular"in thisLink&&(line[3].c=1),"direction"in thisLink&&(line[3].d=1),"pickup"in thisLink&&(line[3].u=thisLink.pickup),"setdown"in thisLink&&(line[3].s=thisLink.setdown),"t"in thisLink&&(line[3].t=thisLink.t),"b"in thisLink&&(line[3].b=thisLink.b),"minutes"in thisLink&&(line[3].m=thisLink.minutes),out.aquius.link.push(line)}for(out.aquius.link.sort((function(a,b){return b[1].reduce((function(c,d){return c+d}),0)-a[1].reduce((function(c,d){return c+d}),0)})),i=0;i<out.summary.network.length;i+=1)for(j=0;j<out.summary.network[i].length;j+=1)out.summary.network[i][j]=Math.round(out.summary.network[i][j]);return delete out._.dayFactor,out}(out=function(out){var contentString,color,position,override,reference,route,routeId,i,j;for(i=0;i<out.gtfs.routes.length;i+=1)if((routeId=(route=out.gtfs.routes[i])[out.gtfsHead.routes.route_id])in out._.routes){if(reference={slug:""},override="agency"===out.config.networkFilter.type&&-1!==out.gtfsHead.routes.agency_id&&route[out.gtfsHead.routes.agency_id]in out.config.productOverride?out.config.productOverride[route[out.gtfsHead.routes.agency_id]]:"mode"===out.config.networkFilter.type&&-1!==out.gtfsHead.routes.route_type&&route[out.gtfsHead.routes.route_type]in out.config.productOverride?out.config.productOverride[route[out.gtfsHead.routes.route_type]]:{},(out.config.allowRoute||out.config.allowRouteLong)&&(contentString="",out.config.allowRoute&&routeId in out.config.routeOverride&&"route_short_name"in out.config.routeOverride[routeId]?contentString=out.config.routeOverride[routeId].route_short_name:out.config.allowRoute&&-1!==out.gtfsHead.routes.route_short_name&&(contentString=route[out.gtfsHead.routes.route_short_name].trim()),out.config.allowRouteLong&&routeId in out.config.routeOverride&&"route_long_name"in out.config.routeOverride[routeId]?(""!==contentString&&(contentString+=": "),contentString+=out.config.routeOverride[routeId].route_long_name):out.config.allowRouteLong&&-1!==out.gtfsHead.routes.route_long_name&&(""!==contentString&&(contentString+=": "),contentString+=route[out.gtfsHead.routes.route_long_name].trim()),""!==contentString&&(reference.n=contentString,reference.slug+=contentString)),out.config.allowColor)for(color=[["route_color","c"],["route_text_color","t"]],j=0;j<color.length;j+=1)contentString="",routeId in out.config.routeOverride&&color[j][0]in out.config.routeOverride[routeId]?contentString=out.config.routeOverride[routeId][color[j][0]]:color[j][0]in override?contentString=override[color[j][0]]:-1!==out.gtfsHead.routes[color[j][0]]&&(contentString=route[out.gtfsHead.routes[color[j][0]]].trim()),6===contentString.length&&(out=addToReference(out,"color",contentString="#"+contentString),"t"===color[j][1]&&"c"in reference&&reference.c===out._.color[contentString]&&(out=addToReference(out,"color",contentString="#ffffff"===contentString.toLowerCase()?"#000000":"#ffffff")),reference[color[j][1]]=out._.color[contentString],reference.slug+=contentString);out.config.allowRouteUrl&&(contentString="",routeId in out.config.routeOverride&&"route_url"in out.config.routeOverride[routeId]?contentString=out.config.routeOverride[routeId].route_url:-1!==out.gtfsHead.routes.route_url&&(contentString=route[out.gtfsHead.routes.route_url].trim()),""!==contentString&&("[*]",-1===(position=contentString.lastIndexOf("[*]"))&&"n"in reference&&-1!==(position=contentString.lastIndexOf(reference.n))&&(contentString=contentString.substring(0,position)+"[*]"+contentString.substring(position+reference.n.length)),-1===position&&-1!==(position=contentString.lastIndexOf(routeId))&&(contentString=contentString.substring(0,position)+"[*]"+contentString.substring(position+routeId.length),reference.i=routeId),out=addToReference(out,"url",contentString),reference.u=out._.url[contentString],reference.slug+=contentString)),"agency"===out.config.networkFilter.type?"agency_id"in out.gtfsHead.routes&&-1!==out.gtfsHead.routes.agency_id?out._.routes[routeId].product=out._.productIndex[route[out.gtfsHead.routes.agency_id]]:out._.routes[routeId].product=0:"mode"===out.config.networkFilter.type&&"route_type"in out.gtfsHead.routes&&-1!==out.gtfsHead.routes.route_type?out._.routes[routeId].product=out._.productIndex[route[out.gtfsHead.routes.route_type]]:out._.routes[routeId].product=out._.productIndex[Object.keys(out._.productIndex)[0]],Object.keys(reference).length>1&&(out._.routes[routeId].reference=reference)}return delete out._.productIndex,out}(out=function(out){var dayCount,hour,inPeriod,minutes,time,total_minutes,i,j,k,dayFactor=function(out){var dayFactor,i,j,k,allDays=Object.keys(out._.calendarDay);if("serviceFilter"in out.config&&"period"in out.config.serviceFilter){for(dayFactor=[],i=0;i<out.config.serviceFilter.period.length;i+=1)if("day"in out.config.serviceFilter.period[i])for(dayFactor.push([]),j=0;j<out.config.serviceFilter.period[i].day.length;j+=1)for(k=0;k<allDays.length;k+=1)out._.calendarDay[allDays[k]]===out.config.serviceFilter.period[i].day[j]&&dayFactor[i].push(allDays[k]);else dayFactor.push(allDays);return dayFactor}return[allDays]}(out),timeFactor=function(out){var timeFactor,i,j;if("serviceFilter"in out.config&&"period"in out.config.serviceFilter){for(timeFactor=[],i=0;i<out.config.serviceFilter.period.length;i+=1)if("time"in out.config.serviceFilter.period[i])for(timeFactor.push([]),j=0;j<out.config.serviceFilter.period[i].time.length;j+=1)"start"in out.config.serviceFilter.period[i].time[j]?timeFactor[i].push([getGtfsTimeSeconds(out.config.serviceFilter.period[i].time[j].start)]):timeFactor[i].push([0]),"end"in out.config.serviceFilter.period[i].time[j]&&timeFactor[i][j].push(getGtfsTimeSeconds(out.config.serviceFilter.period[i].time[j].end));else timeFactor.push([[0]]);return timeFactor}return[[[0]]]}(out),trips=Object.keys(out._.trip),scheduled=[];for(i=0;i<timeFactor.length;i+=1)scheduled.push(0);for(out.summary.service=[],i=0;i<trips.length;i+=1)if(out._.trip[trips[i]].stops.length<2||0===Object.keys(out._.trip[trips[i]].calendar).length)delete out._.trip[trips[i]];else{if(out.config.allowDuration)for(minutes=[],out._.trip[trips[i]].minutes=[],j=0;j<scheduled.length;j+=1)out._.trip[trips[i]].minutes.push(0),minutes.push([]);else minutes=null;for(j=0;j<dayFactor.length;j+=1){for(dayCount=0,k=0;k<dayFactor[j].length;k+=1)dayFactor[j][k]in out._.trip[trips[i]].calendar&&(dayCount+=1);out._.trip[trips[i]].service.push(dayCount/dayFactor[j].length*out.config.servicePer)}if("frequent"in out._.trip[trips[i]]==!1){time="start"in out._.trip[trips[i]]&&"end"in out._.trip[trips[i]]?(out._.trip[trips[i]].end-out._.trip[trips[i]].start)/2+out._.trip[trips[i]].start:null;for(j=0;j<timeFactor.length;j+=1)if(j<out._.trip[trips[i]].service.length&&0!==out._.trip[trips[i]].service[j]){if(timeFactor[j].length>1||timeFactor[j][0].length>1||0!==timeFactor[j][0][0]){if(inPeriod=!1,null!==time)for(k=0;k<timeFactor[j].length;k+=1)if(time>timeFactor[j][k][0]&&(1===timeFactor[j][k].length||time<timeFactor[j][k][1])){inPeriod=!0;break}0==inPeriod&&(out._.trip[trips[i]].service[j]=0,out.config.allowDuration&&(out._.trip[trips[i]].minutes[j]=0))}else inPeriod=!0;if(inPeriod){if(scheduled[j]=scheduled[j]+1,hour=Math.floor(time/3600),void 0===out.summary.service[hour])for(out.summary.service[hour]=[],k=0;k<timeFactor.length;k+=1)out.summary.service[hour].push(0);out.summary.service[hour][j]=out.summary.service[hour][j]+1,out.config.allowDuration&&(out._.trip[trips[i]].start>out._.trip[trips[i]].end?minutes[j].push((out._.trip[trips[i]].end+86400-out._.trip[trips[i]].start)/60):minutes[j].push((out._.trip[trips[i]].end-out._.trip[trips[i]].start)/60))}}}if(null!==minutes)for(j=0;j<minutes.length;j+=1)if(minutes[j].length>0){for(total_minutes=0,k=0;k<minutes[j].length;k+=1)total_minutes+=minutes[j][k];out._.trip[trips[i]].minutes[j]=Math.round(total_minutes/k)}else out._.trip[trips[i]].minutes[j]=0}for(i=0;i<out.summary.service.length;i+=1)if(void 0!==out.summary.service[i])for(j=0;j<out.summary.service[i].length;j+=1)scheduled[j]>0&&(out.summary.service[i][j]=out.summary.service[i][j]/scheduled[j]);return out=function(out,timeFactor){var end,frequencies,frequenciesObject,keys,proportion,start,timeCache,tripId,i,j,k;if("frequencies"in out.gtfs&&-1!==out.gtfsHead.frequencies.trip_id&&-1!==out.gtfsHead.frequencies.start_time&&-1!==out.gtfsHead.frequencies.end_time&&-1!==out.gtfsHead.frequencies.headway_secs){for(frequencies={},timeCache={},i=0;i<out.gtfs.frequencies.length;i+=1)if((tripId=(frequenciesObject=out.gtfs.frequencies[i])[out.gtfsHead.frequencies.trip_id])in out._.trip&&"frequent"in out._.trip[tripId]){if(tripId in frequencies==0)for(frequencies[tripId]=[],j=0;j<timeFactor.length;j+=1)frequencies[tripId].push(0);frequenciesObject[out.gtfsHead.frequencies.start_time]in timeCache==0&&(timeCache[frequenciesObject[out.gtfsHead.frequencies.start_time]]=getGtfsTimeSeconds(frequenciesObject[out.gtfsHead.frequencies.start_time])),start=timeCache[frequenciesObject[out.gtfsHead.frequencies.start_time]],frequenciesObject[out.gtfsHead.frequencies.end_time]in timeCache==0&&(timeCache[frequenciesObject[out.gtfsHead.frequencies.end_time]]=getGtfsTimeSeconds(frequenciesObject[out.gtfsHead.frequencies.end_time])),(end=timeCache[frequenciesObject[out.gtfsHead.frequencies.end_time]])<start&&(end+=86400);for(j=0;j<timeFactor.length;j+=1)if(j<out._.trip[tripId].service.length&&0!==out._.trip[tripId].service[j])if(1===timeFactor[j].length&&1===timeFactor[j][0].length&&0===timeFactor[j][0][0])frequencies[tripId][j]+=(end-start)/parseInt(frequenciesObject[out.gtfsHead.frequencies.headway_secs],10);else for(k=0;k<timeFactor[j].length;k+=1)timeFactor[j][k][0]<end&&(1===timeFactor[j][k].length||start<timeFactor[j][k][1])&&(proportion=1,timeFactor[j][k][0]>start&&(proportion-=(timeFactor[j][k][0]-start)/(end-start)),timeFactor[j][k][1]<end&&(proportion-=(end-timeFactor[j][k][1])/(end-start)),frequencies[tripId][j]+=(end-start)*proportion/parseInt(frequenciesObject[out.gtfsHead.frequencies.headway_secs],10))}for(keys=Object.keys(frequencies),i=0;i<keys.length;i+=1)for(j=0;j<frequencies[keys[i]].length;j+=1)out._.trip[keys[i]].service[j]=out._.trip[keys[i]].service[j]*frequencies[keys[i]][j]}return out}(out,timeFactor),out}(out=function(out){var concurrentCount,dupCalendar,joinOk,keys,lastConcurrentIndex,parentCalendar,tripId,i,j,nextB=0,trips=Object.keys(out._.trip);function equalArrays(a,b){var i;if(a.length!==b.length)return!1;for(i=0;i<a.length;i+=1)if(a[i]!==b[i])return!1;return!0}for(i=0;i<trips.length;i+=1)if("dup"in out._.trip[trips[i]]&&(tripId=out._.trip[trips[i]].dup.trip_id,out._.trip[trips[i]].dup.stops.length>1&&tripId in out._.trip)){for(parentCalendar=[],keys=Object.keys(out._.trip[tripId].calendar),j=0;j<keys.length;j+=1)keys[j]in out._.trip[trips[i]].calendar==!1&&parentCalendar.push(keys[j]);for(dupCalendar=[],keys=Object.keys(out._.trip[trips[i]].calendar),j=0;j<keys.length;j+=1)keys[j]in out._.trip[tripId].calendar==!1&&dupCalendar.push(keys[j]);if(out.config.allowCabotage&&0===parentCalendar.length&&0===dupCalendar.length&&(-1!==out.gtfsHead.stop_times.pickup_type||-1!==out.gtfsHead.drop_off_type)&&("setdown"in out._.trip[trips[i]]&&out._.trip[trips[i]].setdown.length>0&&"setdown"in out._.trip[tripId]&&!1===equalArrays(out._.trip[tripId].setdown,out._.trip[trips[i]].setdown)||"pickup"in out._.trip[trips[i]]&&out._.trip[trips[i]].pickup.length>0&&"pickup"in out._.trip[tripId]&&!1===equalArrays(out._.trip[tripId].pickup,out._.trip[trips[i]].pickup)))"b"in out._.trip[tripId]?out._.trip[trips[i]].b=out._.trip[tripId].b:(out._.trip[tripId].b=nextB,out._.trip[trips[i]].b=nextB,nextB+=1);else if(out.config.allowSplit&&out._.trip[trips[i]].dup.stops.length>=out.config.splitMinimumJoin&&out._.trip[trips[i]].dup.stops.length<out._.trip[trips[i]].stops.length){if(0===dupCalendar.length){for(out._.trip[trips[i]].t=[],lastConcurrentIndex=-1,concurrentCount=0,joinOk=!1,j=0;j<out._.trip[trips[i]].stops.length;j+=1)-1===out._.trip[trips[i]].dup.stops.indexOf(out._.trip[trips[i]].stops[j][1])?out._.trip[trips[i]].t.push(out._.trip[trips[i]].stops[j][1]):(j-1===lastConcurrentIndex?(concurrentCount+=1)===out.config.splitMinimumJoin&&(joinOk=!0):concurrentCount=0,lastConcurrentIndex=j);!1===joinOk&&delete out._.trip[trips[i]].t}else if(0===parentCalendar.length){for(out._.trip[tripId].t=[],lastConcurrentIndex=-1,concurrentCount=0,joinOk=!1,keys={},j=0;j<out._.trip[trips[i]].stops.length;j+=1)keys[out._.trip[trips[i]].stops[j][1]]="";for(j=0;j<out._.trip[tripId].stops.length;j+=1)out._.trip[tripId].stops[j][1]in keys==!1?out._.trip[tripId].t.push(out._.trip[tripId].stops[j][1]):(j-1===lastConcurrentIndex?(concurrentCount+=1)===out.config.splitMinimumJoin&&(joinOk=!0):concurrentCount=0,lastConcurrentIndex=j);!1===joinOk&&delete out._.trip[trips[i]].t}}else if(!1===out.config.allowDuplication)if(0===dupCalendar.length)delete out._.trip[trips[i]];else for(out._.trip[trips[i]].calendar={},j=0;j<dupCalendar.length;j+=1)out._.trip[trips[i]].calendar[dupCalendar[j]]=""}return out}(out=function(out){var arrive,dates,depart,duplicate,key,keys,lastDepart,node,onOffCache,stopObject,times,i,j,k,l,timeCache={},trips=Object.keys(out.gtfs.stop_times);for((!1===out.config.allowDuplicate||out.config.allowSplit||out.config.allowCabotage)&&(duplicate={}),i=0;i<trips.length;i+=1)if(trips[i]in out._.trip){for(dates=Object.keys(out._.trip[trips[i]].calendar),lastDepart=null,onOffCache={},j=0;j<out.gtfs.stop_times[trips[i]].length;j+=1)if((stopObject=out.gtfs.stop_times[trips[i]][j])[out.gtfsHead.stop_times.stop_id]in out._.nodeLookup&&((node=out._.nodeLookup[stopObject[out.gtfsHead.stop_times.stop_id]])in onOffCache==!1&&(onOffCache[node]={}),-1!==out.gtfsHead.stop_times.pickup_type&&"1"===stopObject[out.gtfsHead.stop_times.pickup_type]&&-1!==out.gtfsHead.stop_times.drop_off_type&&"1"===stopObject[out.gtfsHead.stop_times.drop_off_type]?onOffCache[node].route=!0:-1!==out.gtfsHead.stop_times.pickup_type&&"1"===stopObject[out.gtfsHead.stop_times.pickup_type]?onOffCache[node].setdown=!0:-1!==out.gtfsHead.stop_times.drop_off_type&&"1"===stopObject[out.gtfsHead.stop_times.drop_off_type]?onOffCache[node].pickup=!0:onOffCache[node].both=!0,(0===out._.trip[trips[i]].stops.length||out._.trip[trips[i]].stops[out._.trip[trips[i]].stops.length-1][1]!==out._.nodeLookup[stopObject[out.gtfsHead.stop_times.stop_id]])&&(arrive=0,depart=0,out._.trip[trips[i]].stops.push([stopObject[out.gtfsHead.stop_times.stop_sequence],node]),"frequent"in out._.trip[trips[i]]==!1&&(-1!==out.gtfsHead.stop_times.departure_time&&""!==stopObject[out.gtfsHead.stop_times.departure_time]&&(stopObject[out.gtfsHead.stop_times.departure_time]in timeCache==!1&&(timeCache[stopObject[out.gtfsHead.stop_times.departure_time]]=getGtfsTimeSeconds(stopObject[out.gtfsHead.stop_times.departure_time])),depart=timeCache[stopObject[out.gtfsHead.stop_times.departure_time]],("start"in out._.trip[trips[i]]==!1||depart<out._.trip[trips[i]].start)&&(out._.trip[trips[i]].start=depart)),-1!==out.gtfsHead.stop_times.arrival_time&&""!==stopObject[out.gtfsHead.stop_times.arrival_time]&&(stopObject[out.gtfsHead.stop_times.arrival_time]in timeCache==!1&&(timeCache[stopObject[out.gtfsHead.stop_times.arrival_time]]=getGtfsTimeSeconds(stopObject[out.gtfsHead.stop_times.arrival_time])),arrive=timeCache[stopObject[out.gtfsHead.stop_times.arrival_time]],("end"in out._.trip[trips[i]]==!1||arrive>out._.trip[trips[i]].end)&&(out._.trip[trips[i]].end=arrive)),void 0!==duplicate)))){for(times=[],0===arrive&&0===depart||times.push({key:[node,arrive,depart].join(":"),node:node}),!0===out.config.allowSplit&&0!==arrive&&out._.trip[trips[i]].stops.length>1&&times.push({key:[node,arrive,out._.trip[trips[i]].stops[out._.trip[trips[i]].stops.length-1]].join(":"),node:node}),null!==lastDepart&&times.push({key:[node,lastDepart.key].join(":"),node:lastDepart.node}),k=0;k<times.length;k+=1)for(key=[times[k].key,out._.trip[trips[i]].direction_id],out.config.duplicationRouteOnly&&key.push(out._.trip[trips[i]].route_id),key=key.join(":"),l=0;l<dates.length;l+=1)dates[l]in duplicate==!1&&(duplicate[dates[l]]={}),key in duplicate[dates[l]]?("dup"in out._.trip[trips[i]]==!1&&(out._.trip[trips[i]].dup={stops:[],trip_id:duplicate[dates[l]][key]}),0!==out._.trip[trips[i]].dup.stops.length&&-1!==out._.trip[trips[i]].dup.stops.indexOf(times[k].node)||out._.trip[trips[i]].dup.stops.push(times[k].node)):duplicate[dates[l]][key]=trips[i];!0===out.config.allowSplit&&(lastDepart=0!==depart?{key:[depart,node].join(":"),node:node}:null)}for(keys=Object.keys(onOffCache),j=0;j<keys.length;j+=1)"both"in onOffCache[keys[j]]==!1&&("setdown"in onOffCache[keys[j]]&&"pickup"in onOffCache[keys[j]]==!1?out._.trip[trips[i]].setdown.push(parseInt(keys[j],10)):"pickup"in onOffCache[keys[j]]&&"setdown"in onOffCache[keys[j]]==!1?out._.trip[trips[i]].pickup.push(parseInt(keys[j],10)):"route"in onOffCache[keys[j]]&&(out._.trip[trips[i]].setdown.push(parseInt(keys[j],10)),out._.trip[trips[i]].pickup.push(parseInt(keys[j],10))))}return out}(out=function(out){var headsign,tripId,tripObject,i,block={},calendar=function(out){var datesMS,endDateMS,serviceId,startDateMS,i,j,calendar={};if("calendar"in out.gtfs)for(datesMS=Object.keys(out._.calendarDay),i=0;i<out.gtfs.calendar.length;i+=1)for(serviceId=out.gtfs.calendar[i][out.gtfsHead.calendar.service_id],startDateMS=unformatGtfsDate(out.gtfs.calendar[i][out.gtfsHead.calendar.start_date]),endDateMS=unformatGtfsDate(out.gtfs.calendar[i][out.gtfsHead.calendar.end_date]),j=0;j<datesMS.length;j+=1)datesMS[j]>=startDateMS&&datesMS[j]<=endDateMS&&"1"===out.gtfs.calendar[i][out.gtfsHead.calendar[out._.calendarDay[datesMS[j]]]]&&(serviceId in calendar==0&&(calendar[serviceId]={}),calendar[serviceId][datesMS[j]]="");if("calendar_dates"in out.gtfs&&-1!==out.gtfsHead.calendar_dates.service_id&&-1!==out.gtfsHead.calendar_dates.date&&-1!==out.gtfsHead.calendar_dates.exception_type)for(i=0;i<out.gtfs.calendar_dates.length;i+=1)out.gtfs.calendar_dates[i][out.gtfsHead.calendar_dates.date]in out._.calendarGtfs&&((serviceId=out.gtfs.calendar_dates[i][out.gtfsHead.calendar_dates.service_id])in calendar==0&&(calendar[serviceId]={}),"1"===out.gtfs.calendar_dates[i][out.gtfsHead.calendar_dates.exception_type]&&(calendar[serviceId][out._.calendarGtfs[out.gtfs.calendar_dates[i][out.gtfsHead.calendar_dates.date]]]=""),"2"===out.gtfs.calendar_dates[i][out.gtfsHead.calendar_dates.exception_type]&&out._.calendarGtfs[out.gtfs.calendar_dates[i][out.gtfsHead.calendar_dates.date]]in calendar[serviceId]&&(delete calendar[serviceId][out._.calendarGtfs[out.gtfs.calendar_dates[i][out.gtfsHead.calendar_dates.date]]],0===Object.keys(calendar[serviceId]).length&&delete calendar[serviceId]));return calendar}(out),frequent=function(out){var i,frequent={};if("frequencies"in out.gtfs&&-1!==out.gtfsHead.frequencies.trip_id)for(i=0;i<out.gtfs.frequencies.length;i+=1)frequent[out.gtfs.frequencies[i][out.gtfsHead.frequencies.trip_id]]="";return frequent}(out),tripBlock=[],routeExclude={},routeInclude={};if(out.config.routeExclude.length>0)for(i=0;i<out.config.routeExclude.length;i+=1)routeExclude[out.config.routeExclude[i]]="";if(out.config.routeInclude.length>0)for(i=0;i<out.config.routeInclude.length;i+=1)routeInclude[out.config.routeInclude[i]]="";for(out._.trip={},out._.routes={},i=0;i<out.gtfs.trips.length;i+=1)!((tripObject=out.gtfs.trips[i])[out.gtfsHead.trips.service_id]in calendar)||0!==out.config.routeExclude.length&&tripObject[out.gtfsHead.trips.route_id]in routeExclude!=!1||0!==out.config.routeInclude.length&&tripObject[out.gtfsHead.trips.route_id]in routeInclude!=!0||(tripId=tripObject[out.gtfsHead.trips.trip_id],tripObject[out.gtfsHead.trips.route_id]in out._.routes==!1&&(out._.routes[tripObject[out.gtfsHead.trips.route_id]]={}),out._.trip[tripId]={calendar:calendar[tripObject[out.gtfsHead.trips.service_id]],route_id:tripObject[out.gtfsHead.trips.route_id],service:[],stops:[]},-1!==out.gtfsHead.trips.direction_id?out._.trip[tripId].direction_id=tripObject[out.gtfsHead.trips.direction_id]:out._.trip[tripId].direction_id="",tripId in frequent&&(out._.trip[tripId].frequent=""),-1!==out.gtfsHead.stop_times.pickup_type&&(out._.trip[tripId].setdown=[]),-1!==out.gtfsHead.stop_times.drop_off_type&&(out._.trip[tripId].pickup=[]),out.config.allowBlock&&-1!==out.gtfsHead.trips.block_id&&""!==tripObject[out.gtfsHead.trips.block_id]&&(out._.trip[tripId].block={id:tripObject[out.gtfsHead.trips.block_id]},tripBlock.push(tripId),tripObject[out.gtfsHead.trips.block_id]in block?block[tripObject[out.gtfsHead.trips.block_id]].push(tripId):block[tripObject[out.gtfsHead.trips.block_id]]=[tripId]),!0===out.config.allowHeadsign&&-1!==out.gtfsHead.trips.trip_headsign&&(""===(headsign=tripObject[out.gtfsHead.trips.trip_headsign].trim())&&-1!==out.gtfsHead.trips.trip_short_name&&(headsign=tripObject[out.gtfsHead.trips.trip_short_name].trim()),""!==headsign&&(out._.trip[tripId].reference={n:headsign,slug:headsign})));for(i=0;i<tripBlock.length;i+=1)out._.trip[tripBlock[i]].block.trips=block[out._.trip[tripBlock[i]].block.id];return out}(out=function(out){var fromDateMS=unformatGtfsDate(out.config.fromDate),toDateMS=unformatGtfsDate(out.config.toDate);for(out._.calendar={},out._.calendarDay={},out._.calendarGtfs={};toDateMS>=fromDateMS;)out._.calendar[fromDateMS]=formatGtfsDate(fromDateMS),out._.calendarDay[fromDateMS]=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][new Date(fromDateMS).getDay()],out._.calendarGtfs[formatGtfsDate(fromDateMS)]=fromDateMS,fromDateMS+=864e5;return out}(out=function(out){var keys,node,stops,i,j,k;if(!0===out.config.stopPlace&&"place"in out.aquius){for(stops={},keys=Object.keys(out._.nodeLookup),i=0;i<keys.length;i+=1)out._.nodeLookup[keys[i]]in stops==!1&&(stops[out._.nodeLookup[keys[i]]]=[]),stops[out._.nodeLookup[keys[i]]].push(keys[i]);for(i=0;i<out.aquius.place.length;i+=1)for(node=-1,j=0;j<out.aquius.node.length;j+=1)if("p"in out.aquius.node[j][2]&&out.aquius.node[j][2].p===i)if(-1===node)out.aquius.node[j][0]=out.aquius.place[i][0],out.aquius.node[j][1]=out.aquius.place[i][1],"r"in out.aquius.place[i][2]?out.aquius.node[j][2].r=out.aquius.place[i][2].r:"r"in out.aquius.node[j][2]&&delete out.aquius.node[j][2].r,node=j;else if(j in stops)for(k=0;k<stops[j].length;k+=1)out._.nodeLookup[stops[j][k]]=node}return out}(out)))))))))),options),out=function(out,options){if("aquius"in out&&"network"in out.aquius&&"summary"in out&&"network"in out.summary){let tableData,tableFormat,tableHeader,prefix,i;if(prefix="_vars"in options&&"configId"in options._vars?options._vars.configId:"",tableHeader=["Network"],tableFormat=[prefix+"Text"],"service"in out.aquius==!1||0===out.aquius.service.length)tableHeader.push("Service"),tableFormat.push(prefix+"Number");else for(i=0;i<out.aquius.service.length;i+=1)"en-US"in out.aquius.service[i][1]?tableHeader.push(out.aquius.service[i][1]["en-US"]):tableHeader.push(JSON.stringify(out.aquius.service[i][1])),tableFormat.push(prefix+"Number");for(tableData=[],i=0;i<out.summary.network.length;i+=1)"en-US"in out.aquius.network[i][1]?tableData.push([out.aquius.network[i][1]["en-US"]].concat(out.summary.network[i])):tableData.push([JSON.stringify(out.aquius.network[i][1])].concat(out.summary.network[i]));out.networkTable={data:tableData,format:tableFormat,header:tableHeader}}return out}(out,options)),exitProcess(out,options)}};try{module.exports={gtfsToAquius:gtfsToAquius}}catch{}