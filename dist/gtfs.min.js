var gtfsToAquius=gtfsToAquius||{init:function(e){"use strict";var t,s=this.process;function r(e,t,s){var r,o,i=document.createElement(e);if(void 0!==t)for(r=Object.keys(t),o=0;o<r.length;o+=1)i[r[o]]=t[r[o]];if(void 0!==s)for(r=Object.keys(s),o=0;o<r.length;o+=1)i.style[r[o]]=s[r[o]];return i}function o(t){for(var o,i,n,a,f,d,g,p,u,c,l,_,m={},h={},y={},H=[],k=document.getElementById(e+"Output");k.firstChild;)k.removeChild(k.firstChild);for(l=0;l<t.length;l+=1)if(t[l].length>1&&(p=t[l][0].toLowerCase().split(".")).length>1)switch(n=p.pop()){case"txt":try{y[p.join("")]=t[l][1]}catch(e){H.push(p.join("")+"."+n+": "+e.message)}break;case"json":case"geojson":try{"type"in(c=JSON.parse(t[l][1]))&&"FeatureCollection"===c.type?h=c:m=c}catch(e){H.push(p.join("")+"."+n+": "+e.message)}}if(d=H.length>0?{error:H}:s(y,h,m),document.getElementById(e+"Progress").textContent="",document.getElementById(e+"ProcessButton").disabled=!1,g=r("ul",{id:e+"Download"}),"error"in d&&d.error.length>0)for(g.className=e+"Error",l=0;l<d.error.length;l+=1)g.appendChild(r("li",{textContent:"Error: "+d.error[l]}));else g.className=e+"Success";for(a=["aquius","config"],l=0;l<a.length;l+=1)a[l]in d&&Object.keys(d[a[l]]).length>0&&(c="config"===a[l]?JSON.stringify(d[a[l]],null," "):JSON.stringify(d[a[l]]),o=r("li"),i=r("a",{className:e+"Download",href:window.URL.createObjectURL(new Blob([c],{type:"application/json;charset=utf-8"})),download:a[l]+".json",textContent:"Save "+a[l]+".json"}),o.appendChild(i),g.appendChild(o));if(k.appendChild(g),"error"in d!=!1&&0!==d.error.length||"undefined"==typeof aquius||(k.appendChild(r("div",{className:e+"Map",id:e+"Map"},{height:document.documentElement.clientHeight/2+"px"})),aquius.init(e+"Map",{dataObject:d.aquius,uiStore:!1})),"network"in d.aquius&&"link"in d.aquius){for(g=r("table",{className:e+"Summary"}),o=r("tr"),a=["Network","Routes","Services"],l=0;l<a.length;l+=1)o.appendChild(r("th",{textContent:a[l]}));for(g.appendChild(o),l=0;l<d.aquius.network.length;l+=1){o=r("tr"),"en-US"in d.aquius.network[l][1]?o.appendChild(r("td",{textContent:d.aquius.network[l][1]["en-US"]})):o.appendChild(r("td",{textContent:JSON.stringify(d.aquius.network[l][1])})),f=0,u=0;for(_=0;_<d.aquius.link.length;_+=1)-1!==d.aquius.network[l][0].indexOf(d.aquius.link[_][0][0])&&(f+=1,u+=d.aquius.link[_][1].reduce(function(e,t){return e+t},0));o.appendChild(r("td",{textContent:Math.round(f).toString()})),o.appendChild(r("td",{textContent:Math.round(u).toString()})),g.appendChild(o)}k.appendChild(g)}}return!!document.getElementById(e)&&(Object.keys&&[].indexOf&&"object"==typeof JSON&&window.File&&window.FileReader&&window.Blob&&"undefined"!=typeof Promise?void(t="https://timhowgego.github.io/Aquius/dist/aquius.min.js",new Promise(function(e,s){var r;(r=document.createElement("script")).src=t,r.onload=e,r.onerror=s,document.head.appendChild(r)})).then(function(){for(var t,s,i=document.getElementById(e);i.firstChild;)i.removeChild(i.firstChild);t=r("form"),(s=r("label",{textContent:"Select GTFS text files, population GeoJSON and config.json: "})).appendChild(r("input",{id:e+"importFiles",multiple:"multiple",name:e+"importFiles[]",type:"file"})),t.appendChild(s),(s=r("button",{id:e+"ProcessButton",textContent:"Process",type:"button"})).addEventListener("click",function(){document.getElementById(e+"importFiles").files.length>0&&(document.getElementById(e+"ProcessButton").disabled=!0,document.getElementById(e+"Progress").textContent="Working...",function(e,t){var s,r,o=[],i=0,n=0;function a(e,t){o.push([e,t])}!function(e){for(n=e.length,r=0;r<n;r+=1)(s=new FileReader).onload=function(e){return function(){a(e.name,this.result),(i+=1)===n&&t(o)}}(e[r]),s.readAsText(e[r])}(e)}(document.getElementById(e+"importFiles").files,o))},!1),t.appendChild(s),t.appendChild(document.createTextNode(" ")),t.appendChild(r("span",{id:e+"Progress"})),i.appendChild(t),i.appendChild(r("div",{id:e+"Output"}))}()):(document.getElementById(e).appendChild(document.createTextNode("Browser not supported: Try a modern browser")),!1))},process:function(e,t,s){"use strict";var r,o={aquius:{},config:{},error:[]};function i(e){var t,s=["gtfs","gtfsHead","node","nodeLookup"];for(t=0;t<s.length;t+=1)s[t]in e&&delete e[s[t]];return"error"in e&&0===e.error.length&&delete e.error,e}function n(e){var t=new Date(e),s=t.getFullYear().toString();return t.getMonth()<9&&(s+="0"),s+=(t.getMonth()+1).toString(),t.getDate()<10&&(s+="0"),s+=t.getDate().toString()}function a(e){return e.length<8?0:Date.UTC(e.slice(0,4),e.slice(4,6)-1,e.slice(6,8))}return"object"!=typeof t&&(t={}),"object"!=typeof s&&(s={}),(o=function(e,t){function s(e){var t=new RegExp('(\\,|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^\\,\\r\\n]*))',"gi"),s=t.exec(e),r=[[]];for(e=e.trim();null!==s;)s[1].length&&","!==s[1]&&r.push([]),r[r.length-1].push(s[2]?s[2].replace(new RegExp('""',"g"),'"'):s[3]),s=t.exec(e);return r}var r,o,i,n,a;e.gtfsHead={calendar:{service_id:-1,monday:-1,tuesday:-1,wednesday:-1,thursday:-1,friday:-1,saturday:-1,sunday:-1,start_date:-1,end_date:-1},calendar_dates:{service_id:-1,date:-1,exception_type:-1},frequencies:{trip_id:-1,start_time:-1,end_time:-1,headway_secs:-1},routes:{route_color:-1,route_id:-1,route_long_name:-1,route_short_name:-1,route_text_color:-1,route_url:-1},stop_times:{trip_id:-1,stop_id:-1,stop_sequence:-1,pickup_type:-1,drop_off_type:-1},stops:{stop_code:-1,stop_id:-1,stop_lat:-1,stop_lon:-1,stop_name:-1,stop_url:-1,location_type:-1,parent_station:-1},transfers:{from_stop_id:-1,to_stop_id:-1,transfer_type:-1},trips:{route_id:-1,service_id:-1,trip_id:-1}},i={routes:["route_id"],stops:["stop_id","stop_lat","stop_lon"],trips:["route_id","service_id","trip_id"],stop_times:["trip_id","stop_id","stop_sequence"],calendar:["service_id","monday","tuesday","wednesday","thursday","friday","saturday","sunday","start_date","end_date"]},"type"in e.config.productFilter&&"agency"===e.config.productFilter.type&&(e.gtfsHead.agency={agency_id:-1,agency_name:-1},e.gtfsHead.routes.agency_id=-1),"type"in e.config.productFilter&&"mode"===e.config.productFilter.type&&(e.gtfsHead.routes.route_type=-1),"name"in e.config.meta!=0&&"en-US"in e.config.meta.name!=0||("feed_info"in e.gtfsHead==0&&(e.gtfsHead.feed_info={}),e.gtfsHead.feed_info.feed_publisher_name=-1),"url"in e.config.meta==0&&("feed_info"in e.gtfsHead==0&&(e.gtfsHead.feed_info={}),e.gtfsHead.feed_info.feed_publisher_url=-1),e.gtfs={},o=Object.keys(e.gtfsHead);for(n=0;n<o.length;n+=1)if(o[n]in t&&(r=s(t[o[n]])).length>1){for(a=0;a<r[0].length;a+=1)r[0][a]in e.gtfsHead[o[n]]&&(e.gtfsHead[o[n]][r[0][a]]=a);e.gtfs[o[n]]=r.splice(1)}for(o=Object.keys(i),n=0;n<o.length;n+=1)if(o[n]in e.gtfs==0)e.error.push("Missing GTFS "+o[n]+".txt");else if(o[n]in e.gtfsHead)for(a=0;a<i[o[n]].length;a+=1)i[o[n]][a]in e.gtfsHead[o[n]]!=0&&-1!==e.gtfsHead[o[n]][i[o[n]][a]]||e.error.push("Missing value "+i[o[n]][a]+" in GTFS "+o[n]+".txt");return e}(o=function(e,t){var s,r={allowName:!0,allowURL:!0,fromDate:n(Date.now()),meta:{schema:"0"},option:{},populationProperty:"population",productFilter:{type:"agency"},servicePer:1,toDate:n(Date.now()+5184e5),translation:{}},o=Object.keys(r);for(s=0;s<o.length;s+=1)o[s]in t&&typeof t[o[s]]==typeof r[o[s]]?e.config[o[s]]=t[o[s]]:e.config[o[s]]=r[o[s]];return e}(o,s),e)).error.length>0?i(o):(o=function(e){function t(t){var s={};return!0===e.config.allowName&&-1!==e.gtfsHead.stops.stop_name&&""!==t[e.gtfsHead.stops.stop_name]&&(s.n=t[e.gtfsHead.stops.stop_name],-1!==e.gtfsHead.stops.stop_code&&""!==t[e.gtfsHead.stops.stop_code]&&(s.n+=" ("+t[e.gtfsHead.stops.stop_code]+")")),!0===e.config.allowURL&&-1!==e.gtfsHead.stops.stop_url&&""!==t[e.gtfsHead.stops.stop_url]&&(s.u=t[e.gtfsHead.stops.stop_url]),Object.keys(s).length>0?{r:[s]}:{}}function s(e){return e=parseFloat(e),Number.isNaN(e)?0:Math.round(1e5*e)/1e5}return e.aquius.node=[],e.nodeLookup={},e=function(e){var r;for(r=0;r<e.gtfs.stops.length;r+=1)e.gtfs.stops[r].stop_id in e.nodeLookup==0&&""!==e.gtfs.stops[r][e.gtfsHead.stops.stop_id]&&(e.nodeLookup[e.gtfs.stops[r][e.gtfsHead.stops.stop_id]]=e.aquius.node.length,e.aquius.node.push([s(e.gtfs.stops[r][e.gtfsHead.stops.stop_lon]),s(e.gtfs.stops[r][e.gtfsHead.stops.stop_lat]),t(e.gtfs.stops[r])]));return e}(e=function(e){var r,o,i,n;if("transfers"in e.gtfs&&-1!==e.gtfsHead.transfers.from_stop_id&&-1!==e.gtfsHead.transfers.to_stop_id&&1!==e.gtfsHead.transfers.transfer_type)for(i=0;i<e.gtfs.transfers.length;i+=1)if(""!==e.gtfs.transfers[i][e.gtfsHead.transfers.from_stop_id]&&(r=e.nodeLookup[e.gtfs.transfers[i][e.gtfsHead.transfers.from_stop_id]])!==(o=e.nodeLookup[e.gtfs.transfers[i][e.gtfsHead.transfers.to_stop_id]]))if(void 0!==r&&void 0!==o);else if(void 0!==r)e.nodeLookup[o]=r;else if(void 0!==o)e.nodeLookup[r]=o;else if(void 0===r&&void 0===o)for(n=0;n<e.gtfs.stops.length;n+=1)if(e.gtfs.stops[n][e.gtfsHead.stops.stop_id]===r){e.nodeLookup[r]=e.aquius.node.length,e.nodeLookup[o]=e.aquius.node.length,e.aquius.node.push([s(e.gtfs.stops[n][e.gtfsHead.stops.stop_lon]),s(e.gtfs.stops[n][e.gtfsHead.stops.stop_lat]),t(e.gtfs.stops[n])]);break}return e}(e=function(e){var r,o=[];if(-1!==e.gtfsHead.stops.location_type&&-1!==e.gtfsHead.stops.parent_station){for(r=0;r<e.gtfs.stops.length;r+=1)"1"===e.gtfs.stops[r][e.gtfsHead.stops.location_type]?(e.nodeLookup[e.gtfs.stops[r][e.gtfsHead.stops.stop_id]]=e.aquius.node.length,e.aquius.node.push([s(e.gtfs.stops[r][e.gtfsHead.stops.stop_lon]),s(e.gtfs.stops[r][e.gtfsHead.stops.stop_lat]),t(e.gtfs.stops[r])])):""!==e.gtfs.stops[r][e.gtfsHead.stops.parent_station]&&o.push([e.gtfs.stops[r][e.gtfsHead.stops.stop_id],e.gtfs.stops[r][e.gtfsHead.stops.parent_station]]);for(r=0;r<o.length;r+=1)o[r][1]in e.nodeLookup&&(e.nodeLookup[o[r][0]]=e.nodeLookup[o[r][1]])}return e}(e)))}(o=function(e){var t,s,r,o={0:{"en-US":"Tram"},1:{"en-US":"Metro"},2:{"en-US":"Rail"},3:{"en-US":"Bus"},4:{"en-US":"Ferry"},5:{"en-US":"Cable car"},6:{"en-US":"Cable car"},7:{"en-US":"Funicular"},100:{"en-US":"Rail"},101:{"en-US":"High speed rail"},102:{"en-US":"Long distance rail"},103:{"en-US":"Inter-regional rail"},105:{"en-US":"Sleeper rail"},106:{"en-US":"Regional rail"},107:{"en-US":"Tourist rail"},108:{"en-US":"Rail shuttle"},109:{"en-US":"Suburban rail"},200:{"en-US":"Coach"},201:{"en-US":"International coach"},202:{"en-US":"National coach"},204:{"en-US":"Regional coach"},208:{"en-US":"Commuter coach"},400:{"en-US":"Urban rail"},401:{"en-US":"Metro"},402:{"en-US":"Underground"},405:{"en-US":"Monorail"},700:{"en-US":"Bus"},701:{"en-US":"Regional bus"},702:{"en-US":"Express bus"},704:{"en-US":"Local bus"},800:{"en-US":"Trolleybus"},900:{"en-US":"Tram"},1000:{"en-US":"Water"},1300:{"en-US":"Telecabin"},1400:{"en-US":"Funicular"},1501:{"en-US":"Shared taxi"},1700:{"en-US":"Other"},1701:{"en-US":"Cable car"},1702:{"en-US":"Horse-drawn"}};switch("type"in e.config.productFilter==0&&(e.config.productFilter.type="agency"),"index"in e.config.productFilter!=0&&"object"==typeof e.config.productFilter.index||(e.config.productFilter.index=[]),e.config.productFilter.type){case"mode":if("route_type"in e.gtfsHead.routes&&-1!==e.gtfsHead.routes.route_type)for(s=0;s<e.gtfs.routes.length;s+=1)-1===e.config.productFilter.index.indexOf(e.gtfs.routes[s][e.gtfsHead.routes.route_type])&&e.config.productFilter.index.push(e.gtfs.routes[s][e.gtfsHead.routes.route_type]);break;case"agency":default:if(e.config.productFilter.type="agency","agency"in e.gtfs&&"agency_id"in e.gtfsHead.agency&&1!==e.gtfsHead.agency.agency_id)for(s=0;s<e.gtfs.agency.length;s+=1)-1===e.config.productFilter.index.indexOf(e.gtfs.agency[s][e.gtfsHead.agency.agency_id])&&e.config.productFilter.index.push(e.gtfs.agency[s][e.gtfsHead.agency.agency_id]);else e.config.productFilter.index.push("agency")}if("network"in e.config.productFilter==0||!Array.isArray(e.config.productFilter.network))switch(e.config.productFilter.network=[],e.config.productFilter.type){case"mode":if(e.config.productFilter.network.push([e.config.productFilter.index,{"en-US":"All modes"}]),e.config.productFilter.index.length>1)for(s=0;s<e.config.productFilter.index.length;s+=1)e.config.productFilter.index[s]in o?e.config.productFilter.network.push([[e.config.productFilter.index[s]],o[e.config.productFilter.index[s]]]):e.config.productFilter.network.push([[e.config.productFilter.index[s]],{"en-US":"Mode #"+e.config.productFilter.index[s]}]);break;case"agency":if(e.config.productFilter.network.push([e.config.productFilter.index,{"en-US":"All operators"}]),e.config.productFilter.index.length>1)for(s=0;s<e.config.productFilter.index.length;s+=1)if("agency"in e.gtfs&&-1!==e.gtfsHead.agency.agency_id&&-1!==e.gtfsHead.agency.agency_name){for(r=0;r<e.gtfs.agency.length;r+=1)if(e.gtfs.agency[r][e.gtfsHead.agency.agency_id]===e.config.productFilter.index[s]){e.config.productFilter.network.push([[e.config.productFilter.index[s]],{"en-US":e.gtfs.agency[r][e.gtfsHead.agency.agency_name]}]);break}}else e.config.productFilter.network.push([[e.config.productFilter.index[s]],{"en-US":e.config.productFilter.index[s]}]);break;default:e.config.productFilter.network.push([e.config.productFilter.index,{"en-US":"All"}])}for(e.aquius.network=[],s=0;s<e.config.productFilter.network.length;s+=1)if(e.config.productFilter.network[s].length>1&&Array.isArray(e.config.productFilter.network[s][0])&&"object"==typeof e.config.productFilter.network[s][1]){for(t=[],r=0;r<e.config.productFilter.network[s][0].length;r+=1)t.push(e.config.productFilter.index.indexOf(e.config.productFilter.network[s][0][r]));e.aquius.network.push([t,e.config.productFilter.network[s][1]])}return e}(o=function(e){if("schema"in e.config.meta!=0&&"0"===e.config.meta.schema||(e.config.meta.schema="0"),"name"in e.config.meta==0&&(e.config.meta.name={}),"en-US"in e.config.meta.name==0&&("feed_info"in e.gtfs&&-1!==e.gtfsHead.feed_info.feed_publisher_name?e.config.meta.name["en-US"]=e.gtfs.feed_info[0][e.gtfsHead.feed_info.feed_publisher_name]+" ":e.config.meta.name["en-US"]="",e.config.meta.name["en-US"]+="("+e.config.fromDate,e.config.fromDate!==e.config.toDate&&(e.config.meta.name["en-US"]+="-"+e.config.toDate),e.config.meta.name["en-US"]+=")"),"url"in e.config.meta==0&&"feed_info"in e.gtfs&&-1!==e.gtfsHead.feed_info.feed_publisher_url&&(e.config.meta.url=e.gtfs.feed_info[0][e.gtfsHead.feed_info.feed_publisher_url]),e.aquius.meta=e.config.meta,"en-US"in e.config.translation==0&&(e.config.translation["en-US"]={}),"link"in e.config.translation["en-US"]==0)switch(e.config.servicePer){case 1:e.config.translation["en-US"].link="Daily Services";break;case 7:e.config.translation["en-US"].link="Weekly Services";break;default:e.config.translation["en-US"].link="Services per "+e.config.servicePer+" Days"}return e.aquius.translation=e.config.translation,"c"in e.config.option!=0&&"k"in e.config.option!=0||(e.config.option.c=parseFloat(e.gtfs.stops[0][e.gtfsHead.stops.stop_lon]),e.config.option.k=parseFloat(e.gtfs.stops[0][e.gtfsHead.stops.stop_lat]),e.config.option.m=12),"x"in e.config.option!=0&&"y"in e.config.option!=0||(e.config.option.x=parseFloat(e.gtfs.stops[0][e.gtfsHead.stops.stop_lon]),e.config.option.y=parseFloat(e.gtfs.stops[0][e.gtfsHead.stops.stop_lat]),e.config.option.z=10),e.aquius.option=e.config.option,e}(o))),i(o=function(e,t){var s,r,o,i,n,a,f,d,g={},p=[],u=[],c=-1,l=0,_=[],m=0;function h(e,t,s){var r;function o(s){var r,o,i,n,a,f,d,g;if(Array.isArray(s))for(f=0;f<s.length;f+=1)if(Array.isArray(s[f])){for(r=!1,d=0,g=s[f].length-1;d<s[f].length;g=d++)o=s[f][d][0],n=s[f][d][1],i=s[f][g][0],a=s[f][g][1],n>t!=a>t&&e<(i-o)*(t-n)/(a-n)+o&&(r=!r);if(r)return!0}return!1}if("geometry"in s==0||"type"in s.geometry==0||"coordinates"in s.geometry==0||!Array.isArray(s.geometry.coordinates))return!1;if("MultiPolygon"===s.geometry.type)for(r=0;r<s.geometry.coordinates.length;r+=1)if(o(s.geometry.coordinates[r]))return!0;return"Polygon"===s.geometry.type&&o(s.geometry.coordinates)}function y(e){var t,s={};function r(e){var t,s,r={};if(Array.isArray(e))for(t=0;t<e.length;t+=1)if(Array.isArray(e[t]))for(s=0;s<e[t].length;s+=1)Array.isArray(e[t][s])&&2===e[t][s].length&&("maxX"in r==0?(r.maxX=e[t][s][0],r.minX=e[t][s][0],r.maxY=e[t][s][1],r.minY=e[t][s][1]):(e[t][s][0]>r.maxX?r.maxX=e[t][s][0]:e[t][s][0]<r.minX&&(r.minX=e[t][s][0]),e[t][s][1]>r.maxY?r.maxY=e[t][s][1]:e[t][s][1]<r.minY&&(r.minY=e[t][s][1])));return r}if("geometry"in e&&"type"in e.geometry&&"coordinates"in e.geometry&&Array.isArray(e.geometry.coordinates)){if("MultiPolygon"===e.geometry.type)for(t=0;t<e.geometry.coordinates.length;t+=1)s=r(e.geometry.coordinates[t]);"Polygon"===e.geometry.type&&(s=r(e.geometry.coordinates))}return"maxX"in s?{x:Math.round((s.maxX+s.minX)/2*1e5)/1e5,y:Math.round((s.maxY+s.minY)/2*1e5)/1e5}:null}if(e.aquius.place=[],"type"in t&&"FeatureCollection"===t.type&&"features"in t&&Array.isArray(t.features)&&t.features.length>0){for(f=0;f<t.features.length;f+=1)null!==(s=y(t.features[f]))&&(p.push(f),g[f]=s);for(f=0;f<e.aquius.node.length;f+=1)u.push([e.aquius.node[f][0]+e.aquius.node[f][1],f]);for(u.sort(),f=0;f<u.length;f+=1){if(c=-1,h(e.aquius.node[u[f][1]][0],e.aquius.node[u[f][1]][1],t.features[l]))c=l;else{for(r=[l],d=0;d<p.length;d+=1)if(a=Math.abs(e.aquius.node[u[f][1]][0]+e.aquius.node[u[f][1]][1]-(g[p[d]].x+g[p[d]].y)),0===d&&(o=a),o>=a&&-1===r.indexOf(p[d])){if(h(e.aquius.node[u[f][1]][0],e.aquius.node[u[f][1]][1],t.features[p[d]])){c=p[d];break}r.push(p[d]),r.length<5&&(o=a)}if(-1===c)for(d=0;d<t.features.length;d+=1)if(-1===r.indexOf(d)&&h(e.aquius.node[u[f][1]][0],e.aquius.node[u[f][1]][1],t.features[d])){c=d;break}}-1!==c&&(l=c,-1!==(i=_.indexOf(c))?e.aquius.node[u[f][1]][2].p=i:c in g&&(e.aquius.place.push([g[c].x,g[c].y,{}]),e.aquius.node[u[f][1]][2].p=e.aquius.place.length-1,_.push(c),"properties"in t.features[c]&&e.config.populationProperty in t.features[c].properties&&(n=parseFloat(t.features[c].properties[e.config.populationProperty]),Number.isNaN(n)||(e.aquius.place[e.aquius.place.length-1][2].p=n,n>m&&(m=n)))))}}return m>0&&"placeScale"in e.config.option==0&&(e.config.option.placeScale=Math.round(1/(m/2e6)*1e5)/1e5,e.aquius.option.placeScale=e.config.option.placeScale),e}(o=r=function(e,t){var s,r,o,i,n=Object.keys(t),f=e.config.servicePer/(1+(a(e.config.toDate)-a(e.config.fromDate))/864e5);for(e.aquius.link=[],o=0;o<n.length;o+=1){if(r=(r=t[n[o]].service*f)<1?parseFloat(r.toPrecision(1)):parseInt(r,10),s=[[t[n[o]].product],[r],t[n[o]].route,{}],"reference"in t[n[o]]){for(i=0;i<t[n[o]].reference.length;i+=1)delete t[n[o]].reference[i].slug;s[3].r=t[n[o]].reference}"color"in t[n[o]]&&(s[3].o=t[n[o]].color),"circular"in t[n[o]]&&(s[3].c=1),"direction"in t[n[o]]&&(s[3].d=1),"pickup"in t[n[o]]&&(s[3].u=t[n[o]].pickup),"setdown"in t[n[o]]&&(s[3].s=t[n[o]].setdown),e.aquius.link.push(s)}return e}(r=o,function(e,t,s){var r,o,i,n,a;function f(e){var t,s;if(e.length<3||e[0]!==e[e.length-1])return 0;for(t=e.slice(1,e.length-2),s=0;s<t.length;s+=1)if(t.indexOf(t[s])!==t.lastIndexOf(t[s]))return 0;return 1}var d={};for(n=0;n<e.gtfs.trips.length;n+=1)if(e.gtfs.trips[n][e.gtfsHead.trips.trip_id]in t){for(i=[],t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].stops.sort(function(e,t){return e[0]-t[0]}),a=0;a<t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].stops.length;a+=1)i.push(t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].stops[a][1]);o="f"+s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]],-1!==e.gtfsHead.stop_times.pickup_type&&t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].setdown.length>0&&(t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].setdown.sort(),o+="s"+t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].setdown.join(":")),-1!==e.gtfsHead.stop_times.drop_off_type&&t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].pickup.length>0&&(t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].pickup.sort(),o+="p"+t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].pickup.join(":")),r=i.slice().reverse().join(":")+o,(o=i.join(":")+o)in d?(d[o].service+=t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].service,"reference"in s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]]&&-1===d[o].referenceLookup.indexOf(s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].reference.slug)&&(d[o].reference.push(s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].reference),d[o].referenceLookup.push(s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].reference.slug))):r in d?(d[r].service+=t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].service,"reference"in s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]]&&-1===d[r].referenceLookup.indexOf(s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].reference.slug)&&(d[r].reference.push(s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].reference),d[r].referenceLookup.push(s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].reference.slug)),"direction"in d[r]&&delete d[r].direction):(d[o]={direction:1,product:s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].product,route:i,service:t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].service},"reference"in s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]]&&(d[o].reference=[s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].reference],d[o].referenceLookup=[s[e.gtfs.trips[n][e.gtfsHead.trips.route_id]].reference.slug]),-1!==e.gtfsHead.stop_times.pickup_type&&t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].setdown.length>0&&(d[o].setdown=t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].setdown),-1!==e.gtfsHead.stop_times.drop_off_type&&t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].pickup.length>0&&(d[o].pickup=t[e.gtfs.trips[n][e.gtfsHead.trips.trip_id]].pickup),f(i)&&(d[o].circular=1))}return d}(r,function(e,t,s){var r,o={};for(r=0;r<e.gtfs.trips.length;r+=1)s[e.gtfs.trips[r][e.gtfsHead.trips.service_id]]>0&&(o[e.gtfs.trips[r][e.gtfsHead.trips.trip_id]]={stops:[]},e.gtfs.trips[r][e.gtfsHead.trips.trip_id]in t?o[e.gtfs.trips[r][e.gtfsHead.trips.trip_id]].service=t[e.gtfs.trips[r][e.gtfsHead.trips.trip_id]]*s[e.gtfs.trips[r][e.gtfsHead.trips.service_id]]:o[e.gtfs.trips[r][e.gtfsHead.trips.trip_id]].service=s[e.gtfs.trips[r][e.gtfsHead.trips.service_id]],-1!==e.gtfsHead.stop_times.pickup_type&&(o[e.gtfs.trips[r][e.gtfsHead.trips.trip_id]].setdown=[]),-1!==e.gtfsHead.stop_times.drop_off_type&&(o[e.gtfs.trips[r][e.gtfsHead.trips.trip_id]].pickup=[]));for(r=0;r<e.gtfs.stop_times.length;r+=1)void 0!==o[e.gtfs.stop_times[r][e.gtfsHead.stop_times.trip_id]]&&(0!==o[e.gtfs.stop_times[r][e.gtfsHead.stop_times.trip_id]].stops.length&&o[e.gtfs.stop_times[r][e.gtfsHead.stop_times.trip_id]].stops[o[e.gtfs.stop_times[r][e.gtfsHead.stop_times.trip_id]].stops.length-1]===e.nodeLookup[e.gtfs.stop_times[r][e.gtfsHead.stop_times.stop_id]]||(o[e.gtfs.stop_times[r][e.gtfsHead.stop_times.trip_id]].stops.push([e.gtfs.stop_times[r][e.gtfsHead.stop_times.stop_sequence],e.nodeLookup[e.gtfs.stop_times[r][e.gtfsHead.stop_times.stop_id]]]),-1!==e.gtfsHead.stop_times.pickup_type&&"1"===e.gtfs.stop_times[r][e.gtfsHead.stop_times.pickup_type]&&o[e.gtfs.stop_times[r][e.gtfsHead.stop_times.trip_id]].setdown.push(e.nodeLookup[e.gtfs.stop_times[r][e.gtfsHead.stop_times.stop_id]]),-1!==e.gtfsHead.stop_times.drop_off_type&&"1"===e.gtfs.stop_times[r][e.gtfsHead.stop_times.drop_off_type]&&o[e.gtfs.stop_times[r][e.gtfsHead.stop_times.trip_id]].pickup.push(e.nodeLookup[e.gtfs.stop_times[r][e.gtfsHead.stop_times.stop_id]])));return o}(r,function(e){var t,s,r={};function o(e,t){function s(e){var t,s,r=e.split(":");if(r.length<3)return-1;for(s=0;s<r.length;s+=1){if(t=parseInt(r[s],10),Number.isNaN(t))return-1;r[s]=t}return 3600*r[0]+60*r[1]+r[2]}var r=s(e),o=s(t);return r>o?o-r-86400:o-r}if("frequencies"in e.gtfs&&-1!==e.gtfsHead.frequencies.trip_id&&-1!==e.gtfsHead.frequencies.start_time&&-1!==e.gtfsHead.frequencies.end_time&&-1!==e.gtfsHead.frequencies.headway_secs)for(t=0;t<e.gtfs.frequencies.length;t+=1)s=o(e.gtfs.frequencies[t][e.gtfsHead.frequencies.start_time],e.gtfs.frequencies[t][e.gtfsHead.frequencies.end_time])/parseInt(e.gtfs.frequencies[t][e.gtfsHead.frequencies.headway_secs],10),e.gtfs.frequencies[t][e.gtfsHead.frequencies.trip_id]in r?r[e.gtfs.frequencies[t][e.gtfsHead.frequencies.trip_id]]+=s:r[e.gtfs.frequencies[t][e.gtfsHead.frequencies.trip_id]]=s;return r}(r),function(e){for(var t,s,r,o,i,f,d,g,p={},u={},c=a(e.config.fromDate),l=a(e.config.toDate);l>=c;)u[n(c)]=c,c+=864e5;for(f=0;f<e.gtfs.calendar.length;f+=1){for(s=0,o=a(e.gtfs.calendar[f][e.gtfsHead.calendar.start_date]),r=a(e.gtfs.calendar[f][e.gtfsHead.calendar.end_date]),t=Object.keys(u),d=0;d<t.length;d+=1)u[t[d]]>=o&&u[t[d]]<=r&&(i=parseInt(e.gtfs.calendar[f][e.gtfsHead.calendar[(g=u[t[d]],["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][new Date(g).getDay()])]],10),Number.isNaN(i)||(s+=i));s>0&&(p[e.gtfs.calendar[f][e.gtfsHead.calendar.service_id]]=s)}if("calendar_dates"in e.gtfs&&-1!==e.gtfsHead.calendar_dates.service_id&&-1!==e.gtfsHead.calendar_dates.date&&-1!==e.gtfsHead.calendar_dates.exception_type)for(f=0;f<e.gtfs.calendar_dates.length;f+=1)void 0!==u[e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.date]]&&(void 0===p[e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.service_id]]?"1"===e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.exception_type]&&(p[e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.service_id]]=1):("1"===e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.exception_type]&&(p[e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.service_id]]+=1),"2"===e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.exception_type]&&(1===p[e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.service_id]]?delete p[e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.service_id]]:p[e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.service_id]]=p[e.gtfs.calendar_dates[f][e.gtfsHead.calendar_dates.service_id]]-1)));return p}(r)),function(e){var t,s={};for(t=0;t<e.gtfs.routes.length;t+=1)s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]]={},s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference={slug:""},-1!==e.gtfsHead.routes.route_short_name&&""!==e.gtfs.routes[t][e.gtfsHead.routes.route_short_name]?(s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.n=e.gtfs.routes[t][e.gtfsHead.routes.route_short_name],s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.slug+=e.gtfs.routes[t][e.gtfsHead.routes.route_short_name]):!0===e.config.allowName&&-1!==e.gtfsHead.routes.route_long_name&&""!==e.gtfs.routes[t][e.gtfsHead.routes.route_long_name]&&(s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.n=e.gtfs.routes[t][e.gtfsHead.routes.route_long_name],s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.slug+=e.gtfs.routes[t][e.gtfsHead.routes.route_long_name]),-1!==e.gtfsHead.routes.route_color&&""!==e.gtfs.routes[t][e.gtfsHead.routes.route_color]&&(s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.c=e.gtfs.routes[t][e.gtfsHead.routes.route_color],s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.slug+=e.gtfs.routes[t][e.gtfsHead.routes.route_color]),-1!==e.gtfsHead.routes.route_text_color&&""!==e.gtfs.routes[t][e.gtfsHead.routes.route_text_color]&&(s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.t=e.gtfs.routes[t][e.gtfsHead.routes.route_text_color],s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.slug+=e.gtfs.routes[t][e.gtfsHead.routes.route_text_color]),!0===e.config.allowURL&&-1!==e.gtfsHead.routes.route_url&&""!==e.gtfs.routes[t][e.gtfsHead.routes.route_url]&&(s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.u=e.gtfs.routes[t][e.gtfsHead.routes.route_url],s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].reference.slug+=e.gtfs.routes[t][e.gtfsHead.routes.route_url]),"agency"===e.config.productFilter.type?"agency_id"in e.gtfsHead.routes&&-1!==e.gtfsHead.routes.agency_id?s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].product=e.config.productFilter.index.indexOf(e.gtfs.routes[t][e.gtfsHead.routes.agency_id]):s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].product=0:"mode"===e.config.productFilter.type&&"route_type"in e.gtfsHead.routes&&-1!==e.gtfsHead.routes.route_type?s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].product=e.config.productFilter.index.indexOf(e.gtfs.routes[t][e.gtfsHead.routes.route_type]):s[e.gtfs.routes[t][e.gtfsHead.routes.route_id]].product=e.config.productFilter.index[0];return s}(r))),t)))}};