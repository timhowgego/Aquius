var mergeAquius=mergeAquius||{"init":function init(configId){"use strict";function createElement(elementType,valueObject,styleObject){var values,styles,i;var element=document.createElement(elementType);if(typeof valueObject!=="undefined"){values=Object.keys(valueObject);for(i=0;i<values.length;i+=1){element[values[i]]=valueObject[values[i]]}}if(typeof styleObject!=="undefined"){styles=Object.keys(styleObject);for(i=0;i<styles.length;i+=1){element.style[styles[i]]=styleObject[styles[i]]}}return element}function initialiseUI(vars,loadFunction,prompt){var button,form,label;var baseDOM=document.getElementById(vars.configId);if(!baseDOM){return false}while(baseDOM.firstChild){baseDOM.removeChild(baseDOM.firstChild)}if(!Object.keys||![].indexOf||typeof JSON!=="object"||!window.File||!window.FileReader||!window.Blob){baseDOM.appendChild(document.createTextNode("Browser not supported: Try a modern browser"));return false}document.head.appendChild(createElement("script",{"src":"https://timhowgego.github.io/Aquius/dist/aquius.min.js","type":"text/javascript"}));form=createElement("form",{"className":vars.configId+"Input"});label=createElement("label",{"textContent":prompt});button=createElement("input",{"id":vars.configId+"ImportFiles","multiple":"multiple","name":vars.configId+"ImportFiles[]","type":"file"});button.addEventListener("change",(function(){loadFunction(vars)}),false);label.appendChild(button);form.appendChild(label);form.appendChild(createElement("span",{"id":vars.configId+"Progress"}));baseDOM.appendChild(form);baseDOM.appendChild(createElement("div",{"id":vars.configId+"Output"}));return true}function initialiseMerge(vars){var reader;var loaded=[];var fileDOM=document.getElementById(vars.configId+"ImportFiles");var options={"_vars":vars,"callback":outputMerge};var processedFiles=0;var progressDOM=document.getElementById(vars.configId+"Progress");var totalFiles=0;function loadFiles(fileList){var i;totalFiles=fileList.length;for(i=0;i<totalFiles;i+=1){reader=new FileReader();reader.onerror=(function(evt,theFile){outputError(new Error("Could not read "+theFile.name),vars);reader.abort()});reader.onload=(function(theFile){return function(){try{onLoad(theFile.name,this.result)}catch(err){outputError(err,vars)}}})(fileList[i]);reader.readAsText(fileList[i])}}function onLoad(filename,result){var input,json,i;try{json=JSON.parse(result);if(typeof json==="object"){if(filename.toLowerCase()==="config.json"){options.config=json}else{if("meta"in json&&"schema"in json.meta&&"link"in json&&"node"in json){loaded.push([filename,json])}else{if("config"in options===false){options.config=json}}}}}catch(err){if(err instanceof SyntaxError===false){outputError(err,vars)}}processedFiles+=1;if(processedFiles===totalFiles){loaded.sort();input=[];for(i=0;i<loaded.length;i+=1){input.push(loaded[i][1])}vars.merge(input,options)}}if(fileDOM!==null&&fileDOM.files.length>0){fileDOM.disabled=true;if(progressDOM!==null){while(progressDOM.firstChild){progressDOM.removeChild(progressDOM.firstChild)}progressDOM.textContent="Working..."}loadFiles(fileDOM.files)}}function outputMerge(error,out,options){var keys,i;var vars=options._vars;var fileDOM=document.getElementById(vars.configId+"ImportFiles");var outputDOM=document.getElementById(vars.configId+"Output");var progressDOM=document.getElementById(vars.configId+"Progress");if(error!==undefined){outputError(error,vars);return false}if(!outputDOM||!progressDOM){return false}while(outputDOM.firstChild){outputDOM.removeChild(outputDOM.firstChild)}while(progressDOM.firstChild){progressDOM.removeChild(progressDOM.firstChild)}if(fileDOM!==null){fileDOM.disabled=false}outputDOM.className="";keys=["aquius","config"];for(i=0;i<keys.length;i+=1){if(keys[i]in out&&Object.keys(out[keys[i]]).length>0){progressDOM.appendChild(createElement("a",{"className":vars.configId+"Download","href":window.URL.createObjectURL(new Blob([JSON.stringify(out[keys[i]])],{type:"application/json;charset=utf-8"})),"download":keys[i]+".json","textContent":"Save "+keys[i]+".json","role":"button"}))}}if(typeof aquius!=="undefined"&&"aquius"in out){outputDOM.appendChild(createElement("div",{"id":vars.configId+"Map"},{"height":(document.documentElement.clientHeight/2)+"px"}));aquius.init(vars.configId+"Map",{"dataObject":out.aquius,"uiStore":false})}}function outputError(error,vars){var message;var fileDOM=document.getElementById(vars.configId+"ImportFiles");var outputDOM=document.getElementById(vars.configId+"Output");var progressDOM=document.getElementById(vars.configId+"Progress");if(error!==undefined&&outputDOM!==null){while(outputDOM.firstChild){outputDOM.removeChild(outputDOM.firstChild)}outputDOM.className=vars.configId+"OutputError";if("message"in error){message=error.message}else{message=JSON.stringify(error)}outputDOM.appendChild(createElement("p",{"textContent":"Error: "+message}));if(progressDOM!==null){while(progressDOM.firstChild){progressDOM.removeChild(progressDOM.firstChild)}progressDOM.textContent="Failed"}if(fileDOM!==null){fileDOM.disabled=false}}}return initialiseUI({"configId":configId,"merge":this.merge},initialiseMerge,"Aquius files and optional config to process:")},"merge":function merge(input,options){"use strict";var out={"_":{},"aquius":{},"config":{}};function parseConfig(out,options){var i;var defaults={"coordinatePrecision":5,"meta":{},"option":{},"translation":{}};var keys=Object.keys(defaults);if(typeof options!=="object"){options={}}for(i=0;i<keys.length;i+=1){if("config"in options&&keys[i]in options.config&&typeof options.config[keys[i]]===typeof defaults[keys[i]]){out.config[keys[i]]=options.config[keys[i]]}else{out.config[keys[i]]=defaults[keys[i]]}}return out}function mergePropertyObject(original,addition,appendString){var i;var keys=Object.keys(addition);for(i=0;i<keys.length;i+=1){if(keys[i]in original){if(original[keys[i]]!==addition[keys[i]]&&typeof appendString!=="undefined"&&appendString===true&&typeof original[keys[i]]==="string"&&typeof addition[keys[i]]==="string"){original[keys[i]]+=" | "+addition[keys[i]]}}else{original[keys[i]]=addition[keys[i]]}}return original}function coreLoop(out,input){var i;out.aquius.meta=out.config.meta;out.aquius.meta.schema="0";if(Object.keys(out.config.option).length>0){out.aquius.option=out.config.option}if(Object.keys(out.config.translation).length>0){out.aquius.translation=out.config.translation}out._.blockNext=0;out._.blockSwitch={};out._.colorSwitch={};out._.linkLookup={};out._.nodeLookup={};out._.nodeSwitch={};out._.placeLookup={};out._.placeSwitch={};out._.productNext=0;out._.productSwitch={};out._.serviceLookup={};out._.urlSwitch={};for(i=0;i<input.length;i+=1){if(typeof input[i]==="object"){out=buildMeta(out,input[i]);out=buildOption(out,input[i]);out=buildTranslation(out,input[i]);out=buildService(out,input[i]);out=buildLink(out,input[i],i)}}for(i=0;i<input.length;i+=1){if(typeof input[i]==="object"){out=buildNetwork(out,input[i],i)}}if("link"in out.aquius){out.aquius.link.sort(function(a,b){return b[1].reduce(function(c,d){return c+d},0)-a[1].reduce(function(c,d){return c+d},0)});out=optimiseNode(out)}return out}function buildMeta(out,dataObject){var keys,i;keys=["attribution","description","name","url"];for(i=0;i<keys.length;i+=1){if(("meta"in out.aquius===false||keys[i]in out.aquius.meta===false)&&"meta"in dataObject&&typeof dataObject.meta==="object"&&keys[i]in dataObject.meta){if("meta"in out.aquius===false){out.aquius.meta={}}out.aquius.meta[keys[i]]=dataObject.meta[keys[i]]}}return out}function buildOption(out,dataObject){var keys,i;if("option"in dataObject&&typeof dataObject.option==="object"){keys=Object.keys(dataObject.option);if(keys.length>0){if("option"in out.aquius===false){out.aquius.option={}}for(i=0;i<keys.length;i+=1){if(keys[i]in out.aquius.option===false){out.aquius.option[keys[i]]=dataObject.option[keys[i]]}}}}return out}function buildTranslation(out,dataObject){var keys,i;if("translation"in dataObject&&typeof dataObject.translation==="object"){keys=Object.keys(dataObject.translation);if(keys.length>0){if("translation"in out.aquius===false){out.aquius.translation={}}for(i=0;i<keys.length;i+=1){if(keys[i]in out.aquius.translation){out.aquius.translation[keys[i]]=mergePropertyObject(out.aquius.translation[keys[i]],dataObject.translation[keys[i]])}else{out.aquius.translation[keys[i]]=dataObject.translation[keys[i]]}}}}return out}function buildService(out,dataObject){var key,i;if("service"in dataObject&&Array.isArray(dataObject.service)&&dataObject.service.length>0){if("service"in out.aquius===false){out.aquius.service=[]}for(i=0;i<dataObject.service.length;i+=1){if(Array.isArray(dataObject.service[i])&&dataObject.service[i].length>=2&&Array.isArray(dataObject.service[i][0])&&typeof dataObject.service[i][1]==="object"){key=dataObject.service[i][0].join(":");if(key in out._.serviceLookup){out.aquius.service[out._.serviceLookup[key]][1]=mergePropertyObject(out.aquius.service[out._.serviceLookup[key]][1],dataObject.service[i][1],true);if(dataObject.service[i].length>2&&typeof dataObject.service[i][2]==="object"){if(out.aquius.service[out._.serviceLookup[key]].length>2){out.aquius.service[out._.serviceLookup[key]][2]=mergePropertyObject(out.aquius.service[out._.serviceLookup[key]][2],dataObject.service[i][2])}else{out.aquius.service[out._.serviceLookup[key]][2]=dataObject.service[i][2]}}}else{out.aquius.service.push(dataObject.service[i]);out._.serviceLookup[key]=out.aquius.service.length-1}}}}return out}function buildLink(out,dataObject,iteration){var key,keys,match,node,product,property,reference,i,j,k,l,m;if("link"in dataObject&&Array.isArray(dataObject.link)&&dataObject.link.length>0){if("link"in out.aquius===false){out.aquius.link=[]}for(i=0;i<dataObject.link.length;i+=1){if(dataObject.link[i].length>3&&Array.isArray(dataObject.link[i][0])&&Array.isArray(dataObject.link[i][1])&&Array.isArray(dataObject.link[i][2])&&typeof dataObject.link[i][3]==="object"){product=parseProduct(out,dataObject,dataObject.link[i][0],iteration);out=product.out;node=parseNode(out,dataObject,dataObject.link[i][2],iteration);out=node.out;property=parseLinkProperty(out,dataObject,dataObject.link[i][3],iteration);out=property.out;key="p"+product.product.join(":")+"n"+node.node.join(":");keys=["b","block","d","direction"];for(j=0;j<keys.length;j+=1){if(keys[j]in property.property){key+=j+property.property[keys[j]]}}keys=["h","shared","pickup","s","setdown","split","t","u","duration","m"];for(j=0;j<keys.length;j+=1){if(keys[j]in property.property){key+=j+property.property[keys[j]].join(":")}}if(key in out._.linkLookup){for(j=0;j<out.aquius.link[out._.linkLookup[key]][1].length;j+=1){if(dataObject.link[i][1][j]!==undefined&&dataObject.link[i][1][j]>0){out.aquius.link[out._.linkLookup[key]][1][j]=out.aquius.link[out._.linkLookup[key]][1][j]+dataObject.link[i][1][j]}}keys=["r","reference"];for(j=0;j<keys.length;j+=1){if(keys[j]in property.property){if("r"in out.aquius.link[out._.linkLookup[key]][3]||"reference"in out.aquius.link[out._.linkLookup[key]][3]){for(k=0;k<property.property[keys[j]].length;k+=1){match=false;reference=Object.keys(property.property[keys[j]][k]);for(l=0;l<out.aquius.link[out._.linkLookup[key]][3][keys[j]].length;l+=1){for(m=0;m<reference.length;m+=1){if(reference[m]in out.aquius.link[out._.linkLookup[key]][3][keys[j]][l]&&property.property[keys[j]][k][reference[m]]===out.aquius.link[out._.linkLookup[key]][3][keys[j]][l][reference[m]]){match=true;break}}if(match){break}}if(match===false){out.aquius.link[out._.linkLookup[key]][3][keys[j]].push(property.property[keys[j]][k])}}}else{out.aquius.link[out._.linkLookup[key]][3][keys[j]]=property.property[keys[j]]}}}}else{out.aquius.link.push([product.product,dataObject.link[i][1],node.node,property.property]);out._.linkLookup[key]=out.aquius.link.length-1}}}}return out}function parseProduct(out,dataObject,productArray,iteration){var i;for(i=0;i<productArray.length;i+=1){if(iteration in out._.productSwitch===false){out._.productSwitch[iteration]={}}if(productArray[i]in out._.productSwitch[iteration]===false){out=addProduct(out,dataObject,iteration,productArray[i])}productArray[i]=out._.productSwitch[iteration][productArray[i]];}return{"out":out,"product":productArray}}function parseNode(out,dataObject,nodeArray,iteration){var newNode,i;var node=[];for(i=0;i<nodeArray.length;i+=1){if(iteration in out._.nodeSwitch===false||nodeArray[i]in out._.nodeSwitch[iteration]===false){out=addNode(out,dataObject,nodeArray[i],iteration)}if(iteration in out._.nodeSwitch&&nodeArray[i]in out._.nodeSwitch[iteration]){newNode=out._.nodeSwitch[iteration][nodeArray[i]];if(node.length===0||node[node.length-1]!==newNode){node.push(newNode)}}}return{"out":out,"node":node}}function addNode(out,dataObject,originalNode,iteration){var index,key,keys,place,property,x,y,i,j;function withinKeys(properties,reference){var match,i,j;var keys=Object.keys(properties);for(i=0;i<reference.length;i+=1){match=true;for(j=0;j<keys.length;j+=1){if(keys[j]in reference[i]===false||reference[i][keys[j]]!==properties[keys[j]]){match=false;break}}if(match===true){return true}}return false}if("node"in dataObject&&Array.isArray(dataObject.node)&&dataObject.node[originalNode]!==undefined&&dataObject.node[originalNode].length>=3&&typeof dataObject.node[originalNode][0]==="number"&&typeof dataObject.node[originalNode][1]==="number"&&typeof dataObject.node[originalNode][2]==="object"){x=preciseCoordinate(out,dataObject.node[originalNode][0]);y=preciseCoordinate(out,dataObject.node[originalNode][1]);key=[x,y].join(":");if(key in out._.nodeLookup){index=out._.nodeLookup[key]}else{if("node"in out.aquius===false){out.aquius.node=[]}out.aquius.node.push([x,y,{}]);index=out.aquius.node.length-1;out._.nodeLookup[key]=index}if(iteration in out._.nodeSwitch===false){out._.nodeSwitch[iteration]={}}out._.nodeSwitch[iteration][originalNode]=index;property=dataObject.node[originalNode][2];keys=Object.keys(property);for(i=0;i<keys.length;i+=1){switch(keys[i]){case "r":case "reference":if(Array.isArray(property[keys[i]])&&property[keys[i]].length>0){if(keys[i]in out.aquius.node[index][2]===false){out.aquius.node[index][2][keys[i]]=[]}for(j=0;j<property[keys[i]].length;j+=1){if(typeof property[keys[i]][j]==="object"&&"u"in property[keys[i]][j]){if(iteration in out._.urlSwitch===false||property[keys[i]][j].u in out._.urlSwitch[iteration]===false){out=addReference(out,dataObject,property[keys[i]][j].u,iteration,"url")}if(iteration in out._.urlSwitch&&property[keys[i]][j].u in out._.urlSwitch[iteration]){property[keys[i]][j].u=out._.urlSwitch[iteration][property[keys[i]][j].u]}}if(!withinKeys(property[keys[i]][j],out.aquius.node[index][2][keys[i]])){out.aquius.node[index][2][keys[i]].push(property[keys[i]][j])}}}break;case "p":case "place":if(keys[i]in out.aquius.node[index][2]){if("place"in dataObject&&Array.isArray(dataObject.place)&&dataObject.place[property[keys[i]]]!==undefined&&Array.isArray(dataObject.place[place])&&dataObject.place[property[keys[i]]].length>=3&&typeof dataObject.place[property[keys[i]]][2]==="object"){place=Object.keys(dataObject.place[property[keys[i]]][2]);for(j=0;j<place.length;j+=1){if(place[j]in out.aquius.place[out.aquius.node[index][2][keys[i]]]===false){out.aquius.place[out.aquius.node[index][2][keys[i]]][place[j]]=dataObject.place[property[keys[i]]][2][place[j]]}}}}else{if(iteration in out._.placeSwitch===false||property[keys[i]]in out._.placeSwitch[iteration]===false){out=addPlace(out,dataObject,property[keys[i]],iteration)}if(iteration in out._.placeSwitch&&property[keys[i]]in out._.placeSwitch[iteration]){out.aquius.node[index][2][keys[i]]=out._.placeSwitch[iteration][property[keys[i]]]}}break;default:if(keys[i]in out.aquius.node[index][2]===false){out.aquius.node[index][2][keys[i]]=property[keys[i]]}break}}}return out}function preciseCoordinate(out,numeric){var precision=Math.pow(10,out.config.coordinatePrecision);return Math.round(parseFloat(numeric)*precision)/precision}function addPlace(out,dataObject,originalPlace,iteration){var index,key,keys,x,y,i;if("place"in dataObject&&Array.isArray(dataObject.place)&&dataObject.place[originalPlace]!==undefined&&dataObject.place[originalPlace].length>=3&&typeof dataObject.place[originalPlace][0]==="number"&&typeof dataObject.place[originalPlace][1]==="number"&&typeof dataObject.place[originalPlace][2]==="object"){x=preciseCoordinate(out,dataObject.place[originalPlace][0]);y=preciseCoordinate(out,dataObject.place[originalPlace][1]);key=[x,y].join(":");if(key in out._.placeLookup){index=out._.placeLookup[key]}else{if("place"in out.aquius===false){out.aquius.place=[]}out.aquius.place.push([x,y,{}]);index=out.aquius.place.length-1;out._.placeLookup[key]=index}if(iteration in out._.placeSwitch===false){out._.placeSwitch[iteration]={}}out._.placeSwitch[iteration][originalPlace]=index;keys=Object.keys(dataObject.place[originalPlace][2]);for(i=0;i<keys.length;i+=1){if(keys[i]in out.aquius.place[index][2]===false){out.aquius.place[index][2][keys[i]]=dataObject.place[originalPlace][2][keys[i]]}}}return out}function addReference(out,dataObject,originalIndex,iteration,type){var index;if("reference"in dataObject&&typeof dataObject.reference==="object"&&type in dataObject.reference&&Array.isArray(dataObject.reference[type])&&dataObject.reference[type][originalIndex]!==undefined){if("reference"in out.aquius===false){out.aquius.reference={}}if(type in out.aquius.reference===false){out.aquius.reference[type]=[]}index=out.aquius.reference[type].indexOf(dataObject.reference[type][originalIndex]);if(index===-1){out.aquius.reference[type].push(dataObject.reference[type][originalIndex]);index=out.aquius.reference[type].length-1}if(iteration in out._[type+"Switch"]===false){out._[type+"Switch"][iteration]={}}out._[type+"Switch"][iteration][originalIndex]=index}return out}function parseLinkProperty(out,dataObject,propertyObject,iteration){var keys,node,nodeArray,reference,switchKeys,type,i,j,k;keys=["b","block"];for(i=0;i<keys.length;i+=1){if(keys[i]in propertyObject){if(iteration in out._.blockSwitch===false){out._.blockSwitch[iteration]={}}if(propertyObject[keys[i]]in out._.blockSwitch[iteration]==false){out._.blockSwitch[iteration][propertyObject[keys[i]]]=out._.blockNext;out._.blockNext+=1}propertyObject[keys[i]]=out._.blockSwitch[iteration][propertyObject[keys[i]]];}}keys=["h","shared"];for(i=0;i<keys.length;i+=1){if(keys[i]in propertyObject&&Array.isArray(propertyObject[keys[i]])){for(j=0;j<propertyObject[keys[i]].length;j+=1){if(iteration in out._.productSwitch===false){out._.productSwitch[iteration]={}}if(propertyObject[keys[i]][j]===undefined||propertyObject[keys[i]][j]===null){propertyObject[keys[i]][j]=0}if(propertyObject[keys[i]][j]in out._.productSwitch[iteration]===false){out=addProduct(out,dataObject,iteration,propertyObject[keys[i]][j])}propertyObject[keys[i]][j]=out._.productSwitch[iteration][propertyObject[keys[i]][j]];}}}keys=["pickup","s","setdown","split","t","u"];for(i=0;i<keys.length;i+=1){if(keys[i]in propertyObject&&Array.isArray(propertyObject[keys[i]])){nodeArray=[];for(j=0;j<propertyObject[keys[i]].length;j+=1){if(iteration in out._.nodeSwitch===false||propertyObject[keys[i]][j]in out._.nodeSwitch[iteration]===false){out=addNode(out,dataObject,propertyObject[keys[i]][j],iteration)}if(iteration in out._.nodeSwitch&&propertyObject[keys[i]][j]in out._.nodeSwitch[iteration]){node=out._.nodeSwitch[iteration][propertyObject[keys[i]][j]];if(propertyObject[keys[i]].indexOf(node)===-1){nodeArray.push(node)}}}if(nodeArray.length>0){propertyObject[keys[i]]=nodeArray}else{delete propertyObject[keys[i]]}}}keys=["r","reference"];for(i=0;i<keys.length;i+=1){if(keys[i]in propertyObject&&Array.isArray(propertyObject[keys[i]])){switchKeys=["c","t","u"];for(j=0;j<propertyObject[keys[i]].length;j+=1){reference=propertyObject[keys[i]][j];for(k=0;k<switchKeys.length;k+=1){if(switchKeys[k]in reference){if(switchKeys[k]==="u"){type="url"}else{type="color"}if(iteration in out._[type+"Switch"]===false||reference[switchKeys[k]]in out._[type+"Switch"][iteration]===false){out=addReference(out,dataObject,reference[switchKeys[k]],iteration,type)}if(iteration in out._[type+"Switch"]&&reference[switchKeys[k]]in out._[type+"Switch"][iteration]){propertyObject[keys[i]][j][switchKeys[k]]=out._[type+"Switch"][iteration][reference[switchKeys[k]]]}else{delete propertyObject[keys[i]][j][switchKeys[k]]}}}}}}return{"out":out,"property":propertyObject}}function buildNetwork(out,dataObject,iteration){var index,network,product,i,j;function propertyCheck(network,match){var i;function compareProperties(a,b){var i;var keys=Object.keys(a);for(i=0;i<keys.length;i+=1){if(keys[i]in b===false){return false}if(a[keys[i]]!==b[keys[i]]){return false}}return true}for(i=0;i<network.length;i+=1){if(compareProperties(network[i][1],match[1])&&(network[i].length<3||match.length<3||compareProperties(network[i][2],match[2]))){return i}}return -1}if("network"in dataObject&&Array.isArray(dataObject.network)&&dataObject.network.length>0){if("network"in out.aquius===false){out.aquius.network=[]}for(i=0;i<dataObject.network.length;i+=1){if(Array.isArray(dataObject.network[i])&&dataObject.network[i].length>2&&Array.isArray(dataObject.network[i][0])&&typeof dataObject.network[i][1]==="object"&&typeof dataObject.network[i][2]==="object"){index=propertyCheck(out.aquius.network,dataObject.network[i]);if(index!==-1){for(j=0;j<dataObject.network[i][0].length;j+=1){if(iteration in out._.productSwitch&&dataObject.network[i][0][j]in out._.productSwitch[iteration]){product=out._.productSwitch[iteration][dataObject.network[i][0][j]];if(out.aquius.network[index][0].indexOf(product)===-1){out.aquius.network[index][0].push(product)}}}}else{network=[[],dataObject.network[i][1],dataObject.network[i][2]];for(j=0;j<dataObject.network[i][0].length;j+=1){if(iteration in out._.productSwitch&&dataObject.network[i][0][j]in out._.productSwitch[iteration]){network[0].push(out._.productSwitch[iteration][dataObject.network[i][0][j]])}}out.aquius.network.push(network)}}}}return out}function addProduct(out,dataObject,iteration,product){var keys,match,i,j;var newProduct=true;var reference={};if("reference"in out.aquius===false){out.aquius.reference={}}if("product"in out.aquius.reference===false){out.aquius.reference.product=[]}if("reference"in dataObject&&typeof dataObject.reference==="object"&&"product"in dataObject.reference&&Array.isArray(dataObject.reference.product)&&product>=0&&product<dataObject.reference.product.length&&typeof dataObject.reference.product[product]==="object"){reference=dataObject.reference.product[product];keys=Object.keys(dataObject.reference.product[product]);for(i=0;i<out.aquius.reference.product.length;i+=1){match=true;for(j=0;j<keys.length;j+=1){if(keys[j]in out.aquius.reference.product[i]===false||dataObject.reference.product[product][keys[j]]!==out.aquius.reference.product[i][keys[j]]){match=false;break}}if(match){out._.productSwitch[iteration][product]=i;newProduct=false;break}}}if(newProduct){out._.productSwitch[iteration][product]=out._.productNext;out.aquius.reference.product[out._.productNext]=reference;out._.productNext+=1}return out}function optimiseNode(out){var keys,newNode,newNodeLookup,nodeArray,i,j;var nodeOccurance={};for(i=0;i<out.aquius.link.length;i+=1){nodeArray=out.aquius.link[i][2];if("u"in out.aquius.link[i][3]){nodeArray=nodeArray.concat(out.aquius.link[i][3].u)}if("s"in out.aquius.link[i][3]){nodeArray=nodeArray.concat(out.aquius.link[i][3].s)}if("t"in out.aquius.link[i][3]){nodeArray=nodeArray.concat(out.aquius.link[i][3].t)}for(j=0;j<nodeArray.length;j+=1){if(nodeArray[j]in nodeOccurance===false){nodeOccurance[nodeArray[j]]=1}else{nodeOccurance[nodeArray[j]]+=1}}}nodeArray=[];keys=Object.keys(nodeOccurance);for(i=0;i<keys.length;i+=1){nodeArray.push([keys[i],nodeOccurance[keys[i]]])}nodeArray.sort(function(a,b){return a[1]-b[1]});nodeArray.reverse();newNode=[];newNodeLookup={};for(i=0;i<nodeArray.length;i+=1){newNode.push(out.aquius.node[nodeArray[i][0]]);newNodeLookup[nodeArray[i][0]]=i}out.aquius.node=newNode;for(i=0;i<out.aquius.link.length;i+=1){for(j=0;j<out.aquius.link[i][2].length;j+=1){out.aquius.link[i][2][j]=newNodeLookup[out.aquius.link[i][2][j]]}if("u"in out.aquius.link[i][3]){for(j=0;j<out.aquius.link[i][3].u.length;j+=1){out.aquius.link[i][3].u[j]=newNodeLookup[out.aquius.link[i][3].u[j]]}}if("s"in out.aquius.link[i][3]){for(j=0;j<out.aquius.link[i][3].s.length;j+=1){out.aquius.link[i][3].s[j]=newNodeLookup[out.aquius.link[i][3].s[j]]}}if("t"in out.aquius.link[i][3]){for(j=0;j<out.aquius.link[i][3].t.length;j+=1){out.aquius.link[i][3].t[j]=newNodeLookup[out.aquius.link[i][3].t[j]]}}}return out}function exitMerge(out,options){var error;delete out._;if(typeof options==="object"&&"callback"in options){if("error"in out){error=new Error(out.error.join(". "))}options.callback(error,out,options);return true}else{return out}}out=parseConfig(out,options);out=coreLoop(out,input);return exitMerge(out,options)}};